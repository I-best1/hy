<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é˜³æœ”å¿æ´ªæ°´æ£€æµ‹å¤§å±</title>
  <style>
    html,body{height:100%;margin:0;background:#031824;font-family: "Microsoft Yahei", Arial, sans-serif;color:#c9f3ff}
    .container{width:100%;height:100%;display:grid;grid-template-columns:300px 1fr 360px;grid-template-rows:80px 1fr;grid-template-areas:"header header header" "left main right"}
    header{grid-area:header;padding:12px 24px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:20px}
    .left{grid-area:left;padding:12px 12px;overflow:auto}
    .main{grid-area:main;padding:12px;position:relative}
    .right{grid-area:right;padding:12px 12px;overflow:auto}
    /* å¡ç‰‡ */
    .card{background:rgba(2,35,41,0.7);border-radius:6px;padding:12px;margin-bottom:12px;border:1px solid rgba(0,150,150,0.08)}
  .card-header{display:flex;align-items:center;justify-content:space-between}
  .collapse-btn{cursor:pointer;border:none;background:transparent;color:#9fead6;font-size:14px}
  .card-body{margin-top:8px}
  .card.collapsed .card-body{display:none}
    .map-bg{width:100%;height:100%;background:#071f26;border-radius:6px;position:relative;overflow:hidden}
    #mapCanvas{position:absolute;inset:8px;border-radius:6px}
    .top-controls{position:absolute;left:50%;transform:translateX(-50%);top:12px;display:flex;gap:8px}
    .legend{position:absolute;left:12px;bottom:12px;padding:8px;background:rgba(0,0,0,0.35);border-radius:4px}
    table{width:100%;border-collapse:collapse;color:#bfefff}
    th,td{padding:6px 8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left;font-size:13px}
    .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
    
    /* æ¨¡æ€çª—å£æ ·å¼ */
    .modal {display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);animation:fadeIn 0.3s}
    .modal.show {display:flex;align-items:center;justify-content:center}
    .modal-content {background:rgba(2,35,41,0.95);padding:20px;border-radius:8px;border:1px solid rgba(0,150,150,0.3);max-width:90%;max-height:90%;overflow-y:auto;position:relative;min-width:500px;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
    .modal-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid rgba(0,150,150,0.2);padding-bottom:10px}
    .modal-header h2 {margin:0;font-size:18px;color:#e8fdff}
    .modal-close-btn {background:transparent;border:none;color:#9fead6;font-size:24px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
    .modal-close-btn:hover {color:#e8fdff}
    .modal-body {color:#c9f3ff;white-space:pre-wrap;word-wrap:break-word;line-height:1.7;max-height:calc(90vh - 150px);overflow-y:auto}
    .modal-body.markdown-content {white-space: normal; font-size: 14px;}
    .modal-footer {margin-top:15px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid rgba(0,150,150,0.2);padding-top:10px}
    .modal-btn {padding:8px 16px;border-radius:4px;border:none;cursor:pointer;font-size:14px;transition:all 0.3s}
    .modal-btn-primary {background:#0fbfc6;color:#012;font-weight:bold}
    .modal-btn-primary:hover {background:#13d4d6;box-shadow:0 0 10px rgba(15,191,198,0.5)}
    .modal-btn-secondary {background:rgba(15,191,198,0.2);color:#0fbfc6;border:1px solid #0fbfc6}
    .modal-btn-secondary:hover {background:rgba(15,191,198,0.3)}
    
    /* å·¥å…·æ  */
    .briefing-toolbar {display:flex;gap:8px;margin-bottom:10px}
    .briefing-toolbar button {padding:6px 12px;border-radius:4px;background:#0fbfc6;color:#012;border:none;cursor:pointer;font-size:12px;transition:all 0.3s}
    .briefing-toolbar button:hover {background:#13d4d6;box-shadow:0 0 8px rgba(15,191,198,0.4)}
    
    @keyframes fadeIn {from{opacity:0} to{opacity:1}}
    
    /* Markdown æ ·å¼ */
    .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 {
      color: #0fbfc6;
      margin-top: 1em;
      margin-bottom: 0.5em;
      border-bottom: 1px solid rgba(15, 191, 198, 0.2);
      padding-bottom: 0.3em;
    }
    .markdown-content h1 { font-size: 1.8em; }
    .markdown-content h2 { font-size: 1.5em; }
    .markdown-content h3 { font-size: 1.2em; }
    .markdown-content h4 { font-size: 1.1em; }
    .markdown-content strong { color: #ffd86b; }
    .markdown-content em { color: #9fead6; font-style: italic; }
    .markdown-content ul, .markdown-content ol {
      margin: 0.5em 0;
      padding-left: 2em;
      line-height: 1.8;
    }
    .markdown-content li {
      margin: 0.3em 0;
    }
    .markdown-content p {
      line-height: 1.8;
      margin: 0.5em 0;
    }
    .markdown-content code {
      background: rgba(0, 150, 150, 0.1);
      padding: 2px 4px;
      border-radius: 3px;
      color: #ffd86b;
      font-family: monospace;
    }
    .markdown-content hr {
      border: none;
      border-top: 1px dashed rgba(0, 150, 150, 0.3);
      margin: 1em 0;
    }
    .markdown-content blockquote {
      border-left: 3px solid #0fbfc6;
      padding-left: 1em;
      margin: 0.5em 0;
      color: #9fead6;
    }
  </style>
  <!-- å¼•å…¥ marked.js ç”¨äº Markdown è§£æ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
  <!-- å¼•å…¥ ECharts CDN -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>é˜³æœ”å¿æ´ªæ°´é¢„æŠ¥ç®¡ç†ç³»ç»Ÿ</h1>
      <div>
        <span id="nowTime"></span>
        <span id="selectedInfo" style="margin-left:16px;padding:6px 10px;background:rgba(11,82,96,0.6);border-radius:6px;color:#e8fdff;display:inline-block;min-width:200px;text-align:left">é€‰ä¸­ç«™ç‚¹ï¼š<strong id="selName">-</strong> æ°´ä½ï¼š<span id="selLevel">-</span> m</span>
        <button onclick="openAlertManagement()" style="margin-left:16px;padding:8px 16px;background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(255,107,107,0.4);transition:all 0.3s">
          âš ï¸ è®¾ç½®é¢„è­¦
        </button>
        <button id="apiConfigBtn" onclick="openApiConfig()" style="margin-left:8px;padding:8px 16px;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(155,89,182,0.4);transition:all 0.3s" title="é…ç½® AI æ¨¡å‹">
          âš™ï¸ AI é…ç½®
        </button>
      </div>
    </header>
    <aside class="left">
      <div class="card" id="stationCard">
        <div class="card-header">
          <h3 style="margin:0">æ°´æ–‡ç«™åˆ—è¡¨</h3>
          <button class="collapse-btn" onclick="toggleCard('stationCard')">â–¾</button>
        </div>
        <div class="card-body">
          <table id="stationTable">
            <thead><tr><th>ç«™å</th><th>æ°´ä½(m)</th><th>çŠ¶æ€</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" id="rainCard">
        <div class="card-header">
          <h3 style="margin:0">å®æ—¶é™é›¨</h3>
          <button class="collapse-btn" onclick="toggleCard('rainCard')">â–¾</button>
        </div>
        <div class="card-body">
          <table id="rainTable"><thead><tr><th>ç«™å</th><th>24h(mm)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card" id="levelPercentCard">
        <div class="card-header"><h3 style="margin:0">æ°´ä½æ­£å¸¸æ¯”ä¾‹</h3></div>
        <div class="card-body"><div id="levelPercentChart" style="width:100%;height:160px"></div></div>
      </div>
      <div class="card" id="weatherCard">
        <h3>æ°”è±¡ä¿¡æ¯</h3>
        <div id="weather">--</div>
      </div>
      <div class="card" id="briefingQA">
        <h3 style="margin:0">æ™ºèƒ½åŠ©æ‰‹</h3>
        <div style="margin-bottom:8px;">
          <input id="briefingInput" type="text" placeholder="å‘ç®€æŠ¥åŠ©æ‰‹æé—®..." style="width:80%;padding:6px 8px;border-radius:4px;border:1px solid #0fbfc6;background:#031824;color:#c9f3ff;">
          <button id="briefingAskBtn" style="padding:6px 16px;border-radius:4px;background:#0fbfc6;color:#fff;border:none;cursor:pointer;margin-left:8px;">æé—®</button>
        </div>
        <div id="briefingReply" style="min-height:32px;font-size:15px;color:#ffd86b;"></div>
      </div>
    </aside>
    <main class="main">
      <div class="map-bg card" id="mapCard">
        <div class="top-controls">
          <button id="playBtn">å¼€å§‹æ¨¡æ‹Ÿ</button>
          <button id="pauseBtn">æš‚åœ</button>
        </div>
        <div id="mapCanvas"></div>
        <div class="legend card" id="legend">å›¾ä¾‹ï¼š<div><span class="status-dot" style="background:#2ecc71"></span>æ­£å¸¸ <span class="status-dot" style="background:#f1c40f;margin-left:12px"></span>è­¦æˆ’ <span class="status-dot" style="background:#e74c3c;margin-left:12px"></span>è¶…è­¦</div></div>
      </div>
    </main>
    <aside class="right">
      <div class="card">
        <h3>é€‰ä¸­ç«™ç‚¹æ°´ä½</h3>
        <div id="levelChart" style="width:100%;height:220px"></div>
      </div>

  <div class="card" id="briefingCard">
  <h3 style="display:flex;align-items:center;justify-content:space-between">ç®€æŠ¥ç”Ÿæˆ <button id="briefingGenerateBtn" style="padding:6px 12px;border-radius:4px;background:#0fbfc6;color:#012; border:none;cursor:pointer; font-size:13px;">ç”Ÿæˆç®€æŠ¥</button></h3>
  <div class="briefing-toolbar">
    <button id="briefingEnlargeBtn" title="æ”¾å¤§æŸ¥çœ‹">ğŸ” æ”¾å¤§</button>
    <button id="briefingCopyBtn" title="å¤åˆ¶åˆ°å‰ªè´´æ¿">ğŸ“‹ å¤åˆ¶</button>
  </div>
  <div id="briefingText" style="white-space:pre-line;font-size:15px;line-height:1.7;margin-bottom:10px;">
    ã€æ¡‚æ—æ°´æ–‡ä¸­å¿ƒã€‘8æœˆ15æ—¥8æ—¶ä¿¡æ¯ï¼šæ®æ°´æ–‡ç›‘æµ‹ï¼Œè¿‡å»24å°æ—¶ï¼Œæ¡‚æ—å¸‚æ™®é™å¤§åˆ°æš´é›¨ï¼Œæ­åŸã€å…¨å·ã€é˜³æœ”ã€ä¸´æ¡‚ã€æ°¸ç¦ã€å…´å®‰ã€çµå·ç­‰å¿ï¼ˆåŒºï¼‰å±€éƒ¨é™å¤§æš´é›¨ï¼Œæ—¥é›¨é‡è¾ƒå¤§çš„æœ‰æ­åŸå¿è¥¿å²­é•‡ä¸œé¢æ‘165.5æ¯«ç±³ã€å…¨å·å¿çŸ³å¡˜é•‡ä¹ä¸­æ‘152.5æ¯«ç±³ã€‚å—å¼ºé™é›¨å½±å“ï¼Œæ­åŸæ²³ã€æ¹˜æ±Ÿå…¨å·å¿åŸæ²³æ®µç­‰ä¸»è¦æ±Ÿæ²³åŠæ°¸ç¦å¿å¤§é‚¦æ²³ã€çŒé˜³å¿ç§€æ±Ÿã€é›å±±åŒºè‰¯ä¸°æ²³ã€æ­åŸå¿è¥¿å²­æ²³åŠè²èŠ±æ²³ã€ä¸´æ¡‚åŒºå››å¡˜æ²³åŠä¼šä»™æ²³ã€é˜³æœ”å¿å…´åªæ²³ã€å…¨å·å¿ç‚äº•æ²³ã€çµå·å¿æ¶§æ²™æ²³ç­‰æš´é›¨åŒºä¸­å°æ²³æµå‡ºç°äº†1ï½2.6ç±³çš„æ¶¨æ°´ï¼Œå‡æœªè¶…è­¦ã€‚8æ—¶ï¼Œæ¼“æ±Ÿæ¡‚æ—æ°´æ–‡ç«™æ°´ä½142.20ç±³ï¼ˆè­¦æˆ’æ°´ä½146.0ç±³ï¼‰ï¼Œæµé‡154ç«‹æ–¹ç±³æ¯ç§’ã€‚é¢„è®¡æœªæ¥24å°æ—¶ï¼Œæ¼“æ±Ÿæ¡‚æ—å¸‚åŸåŒºè‡³é˜³æœ”å¿åŸæ²³æ®µæ°´ä½å°†ç»§ç»­ä¸Šæ¶¨1.5ï½2ç±³ï¼Œæ¡‚æ±Ÿå¹³ä¹å¿åŸæ²³æ®µæ°´ä½å°†ç»§ç»­ä¸Šæ¶¨1ç±³å·¦å³ï¼Œä¸ä¼šè¶…è­¦ï¼›å…¨å·ã€æ­åŸã€æ°¸ç¦ã€ä¸´æ¡‚ã€é˜³æœ”ç­‰å¿ï¼ˆåŒºï¼‰éƒ¨åˆ†ä¸­å°æ²³æµå¯èƒ½å‡ºç°è¶…è­¦æ´ªæ°´ã€‚
      </div>
      </div>
    </aside>
  </div>

  <script>
  // ç«™ç‚¹ä½¿ç”¨ç»çº¬åº¦ï¼ˆç¤ºä¾‹ä½ç½®åŸºäºé˜³æœ”å¿èŒƒå›´ï¼Œå¯æ›¿æ¢ä¸ºçœŸå®ç»çº¬åº¦ï¼‰
  // å¦‚æœæ— æ³•é€šè¿‡ fetch åŠ è½½ GeoJSONï¼ˆä¾‹å¦‚ç›´æ¥ä½¿ç”¨ file:// æ‰“å¼€ï¼‰ï¼Œ
  // ä¸‹é¢å†…åµŒçš„ YS_GEO ä¼šä½œä¸ºå›é€€ä½¿ç”¨ï¼Œä»¥ç¡®ä¿åœ°å›¾èƒ½æ¸²æŸ“ã€‚
  const YS_GEO = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"adcode":450321,"name":"é˜³æœ”å¿","center":[110.494699,24.77534],"centroid":[110.476659,24.850756],"childrenNum":0,"level":"district","acroutes":[100000,450000,450300],"parent":{"adcode":450300}},"geometry":{"type":"MultiPolygon","coordinates":[[[[110.610567,25.056975],[110.604754,25.056925],[110.60122,25.05598],[110.592891,25.054765],[110.585073,25.053101],[110.577497,25.053507],[110.56841,25.053444],[110.560606,25.051326],[110.556825,25.050382],[110.552337,25.044609],[110.550848,25.042534],[110.548857,25.040455],[110.547131,25.034932],[110.544651,25.031014],[110.540921,25.025706],[110.537153,25.023847],[110.534391,25.023139],[110.530587,25.024957],[110.52755,25.02724],[110.526249,25.030908],[110.524701,25.035491],[110.522902,25.039845],[110.519084,25.043957],[110.515527,25.046469],[110.511481,25.048281],[110.507449,25.048946],[110.504426,25.0487],[110.497243,25.048374],[110.490266,25.049514],[110.488572,25.049891],[110.486891,25.049776],[110.483887,25.050632],[110.482699,25.050018],[110.48096,25.049539],[110.479206,25.049492],[110.478411,25.049759],[110.476201,25.045037],[110.474804,25.041789],[110.473936,25.040141],[110.472475,25.038892],[110.470822,25.038667],[110.468644,25.039447],[110.467539,25.040455],[110.463621,25.045054],[110.462836,25.045486],[110.46142,25.045778],[110.460004,25.045782],[110.456598,25.0461],[110.456242,25.04679],[110.45636,25.047904],[110.455767,25.049378],[110.453657,25.051136],[110.450397,25.052935],[110.447616,25.054176],[110.445826,25.054735],[110.44447,25.054621],[110.442122,25.054202],[110.44009,25.053118],[110.438236,25.050636],[110.436396,25.04444],[110.43514,25.041759],[110.433588,25.04045],[110.432519,25.039904],[110.429629,25.040556],[110.426912,25.040082],[110.424208,25.038062],[110.414911,25.028252],[110.412687,25.024524],[110.410971,25.021267],[110.410943,25.018331],[110.411569,25.0136],[110.411578,25.011914],[110.41134,25.01074],[110.41034,25.009783],[110.409697,25.009486],[110.408569,25.009554],[110.40639,25.011015],[110.405623,25.01135],[110.405573,25.013341],[110.405071,25.015586],[110.404084,25.016476],[110.402737,25.016692],[110.400906,25.016573],[110.397367,25.014104],[110.395659,25.012202],[110.392486,25.010626],[110.388933,25.010943],[110.387458,25.012053],[110.387696,25.013727],[110.387317,25.016065],[110.385718,25.017171],[110.383266,25.017383],[110.382536,25.016934],[110.380339,25.015137],[110.378522,25.010893],[110.377184,25.009325],[110.375471,25.008647],[110.373143,25.008969],[110.370558,25.010511],[110.367124,25.011833],[110.365174,25.011719],[110.362179,25.010071],[110.359822,25.009359],[110.358859,25.00924],[110.356366,25.008635],[110.348726,25.009855],[110.343004,25.012303],[110.340365,25.013218],[110.338954,25.012943],[110.337835,25.01218],[110.336812,25.011109],[110.336525,25.010444],[110.336876,25.009071],[110.339091,25.00558],[110.340265,25.00439],[110.341635,25.003733],[110.342808,25.003517],[110.343635,25.004144],[110.343721,25.00583],[110.343913,25.006893],[110.345228,25.007258],[110.346986,25.006826],[110.348311,25.005767],[110.349539,25.004135],[110.350133,25.00272],[110.350434,25.000945],[110.349658,24.999835],[110.348347,24.999073],[110.347475,24.999162],[110.346237,24.998128],[110.345397,24.996204],[110.343036,24.995039],[110.342393,24.994895],[110.342292,24.993853],[110.341808,24.991599],[110.341927,24.990573],[110.343808,24.987646],[110.344767,24.985548],[110.344776,24.983921],[110.34384,24.982095],[110.340794,24.980739],[110.325967,24.98026],[110.323342,24.979192],[110.321145,24.977167],[110.310652,24.972315],[110.309186,24.971065],[110.308149,24.969047],[110.308688,24.966661],[110.310697,24.964377],[110.317022,24.961207],[110.320191,24.957986],[110.322725,24.954286],[110.327077,24.943932],[110.328671,24.938892],[110.329575,24.936925],[110.33299,24.931194],[110.338392,24.923606],[110.341552,24.916801],[110.3411,24.908775],[110.338575,24.904523],[110.336625,24.901389],[110.332442,24.899049],[110.327054,24.897904],[110.320163,24.896831],[110.317191,24.897879],[110.312907,24.898298],[110.308802,24.897327],[110.304131,24.895466],[110.301496,24.893511],[110.301359,24.890992],[110.302985,24.888393],[110.306715,24.882714],[110.309515,24.878681],[110.310428,24.876803],[110.310515,24.873813],[110.310113,24.871302],[110.308177,24.868401],[110.304026,24.866518],[110.297076,24.864525],[110.294016,24.863969],[110.291948,24.863146],[110.289833,24.861628],[110.28761,24.858052],[110.286628,24.853959],[110.283463,24.847206],[110.280966,24.84318],[110.27802,24.840325],[110.274162,24.83912],[110.270317,24.83814],[110.265833,24.83926],[110.259111,24.841174],[110.25259,24.841929],[110.246339,24.841432],[110.242759,24.840346],[110.234251,24.83691],[110.231251,24.835332],[110.22889,24.833177],[110.22668,24.830165],[110.226991,24.83002],[110.228872,24.827861],[110.229653,24.825129],[110.229964,24.822825],[110.229644,24.820814],[110.229799,24.818514],[110.230895,24.816931],[110.231831,24.815349],[110.231196,24.81262],[110.231977,24.810316],[110.231964,24.803561],[110.232585,24.801978],[110.236512,24.799674],[110.237137,24.798091],[110.236818,24.796368],[110.235713,24.794501],[110.235398,24.793206],[110.235393,24.792196],[110.235854,24.790329],[110.236799,24.788462],[110.23821,24.786013],[110.240411,24.784858],[110.241827,24.78457],[110.242612,24.783997],[110.243078,24.783275],[110.242918,24.781697],[110.241973,24.780546],[110.240243,24.779256],[110.238973,24.777817],[110.236923,24.775232],[110.236283,24.772215],[110.234703,24.769057],[110.233439,24.767473],[110.232018,24.765899],[110.230128,24.763025],[110.229338,24.761301],[110.229594,24.759145],[110.230534,24.757001],[110.232247,24.755715],[110.235544,24.754993],[110.238201,24.753991],[110.239927,24.752701],[110.24243,24.749131],[110.243992,24.748129],[110.245877,24.748124],[110.249019,24.748982],[110.252001,24.749975],[110.254038,24.750549],[110.256709,24.751117],[110.259709,24.751627],[110.260983,24.750735],[110.261476,24.749682],[110.26112,24.748625],[110.260458,24.747513],[110.260522,24.746957],[110.261252,24.746295],[110.26223,24.746078],[110.263992,24.746142],[110.265029,24.745925],[110.265216,24.745314],[110.264262,24.742644],[110.264568,24.741977],[110.265664,24.74154],[110.268705,24.742444],[110.271011,24.743624],[110.272162,24.744355],[110.273504,24.744469],[110.274965,24.744367],[110.27534,24.744121],[110.277746,24.739374],[110.278874,24.736768],[110.279838,24.735252],[110.28255,24.733452],[110.283436,24.732292],[110.283377,24.728373],[110.284582,24.726785],[110.286258,24.725197],[110.287934,24.724701],[110.289285,24.725214],[110.289911,24.727108],[110.290286,24.731609],[110.291153,24.732484],[110.292824,24.732713],[110.294021,24.732284],[110.295299,24.731278],[110.299318,24.724985],[110.30251,24.722972],[110.305629,24.720815],[110.307711,24.718794],[110.309784,24.717792],[110.317903,24.718862],[110.319889,24.719962],[110.320766,24.720662],[110.322492,24.723546],[110.324547,24.725686],[110.326917,24.727112],[110.329282,24.726968],[110.331808,24.72625],[110.333059,24.725393],[110.334634,24.723822],[110.336844,24.723962],[110.34047,24.723388],[110.342361,24.721957],[110.344868,24.718382],[110.345493,24.716811],[110.346443,24.716667],[110.350388,24.718662],[110.353393,24.719231],[110.357804,24.718654],[110.362681,24.71665],[110.366772,24.713787],[110.368517,24.711418],[110.370837,24.709456],[110.373654,24.705349],[110.373713,24.70007],[110.372992,24.696617],[110.371028,24.691542],[110.369855,24.683493],[110.36991,24.677292],[110.370955,24.674318],[110.373252,24.672738],[110.377033,24.672547],[110.380814,24.672819],[110.385586,24.674475],[110.39086,24.676366],[110.395911,24.676183],[110.400198,24.67462],[110.403998,24.673048],[110.409066,24.670342],[110.413619,24.669463],[110.416879,24.669955],[110.422921,24.670236],[110.428725,24.669136],[110.431734,24.669849],[110.433478,24.671238],[110.434213,24.673316],[110.435958,24.674938],[110.440223,24.676344],[110.44299,24.675907],[110.445511,24.67524],[110.448552,24.672734],[110.451611,24.668622],[110.454904,24.665656],[110.459219,24.662245],[110.465005,24.660903],[110.470055,24.659331],[110.472557,24.659577],[110.478576,24.660529],[110.486608,24.66058],[110.495394,24.661319],[110.503928,24.661599],[110.513185,24.665325],[110.518687,24.667194],[110.523486,24.664463],[110.525034,24.659879],[110.525062,24.657585],[110.526089,24.654836],[110.528619,24.652554],[110.533414,24.650281],[110.538195,24.648934],[110.541496,24.646198],[110.546547,24.643011],[110.55588,24.641414],[110.561209,24.641665],[110.563693,24.641082],[110.565255,24.639786],[110.567319,24.637522],[110.568675,24.635767],[110.570452,24.633825],[110.570895,24.633583],[110.571831,24.633901],[110.574817,24.635176],[110.578438,24.637165],[110.580794,24.638584],[110.582525,24.638869],[110.583968,24.638202],[110.585091,24.639668],[110.587502,24.640777],[110.590475,24.64152],[110.591407,24.641626],[110.591959,24.641979],[110.597937,24.643674],[110.599827,24.645098],[110.601416,24.647384],[110.604097,24.649954],[110.609818,24.656157],[110.611024,24.656773],[110.611376,24.658124],[110.612713,24.659704],[110.614248,24.66106],[110.616097,24.662971],[110.618444,24.664628],[110.619558,24.665707],[110.619024,24.666642],[110.617727,24.667606],[110.617024,24.66787],[110.615019,24.667942],[110.609722,24.668367],[110.608805,24.668524],[110.607284,24.66945],[110.606485,24.670444],[110.60606,24.671247],[110.605594,24.672683],[110.605289,24.675363],[110.604348,24.678005],[110.603978,24.682839],[110.604115,24.685349],[110.605138,24.687299],[110.605247,24.690667],[110.604914,24.693589],[110.60433,24.695216],[110.602572,24.701204],[110.602211,24.705056],[110.601887,24.706029],[110.599813,24.707749],[110.598603,24.708513],[110.598101,24.709452],[110.597982,24.710713],[110.597562,24.712293],[110.59706,24.713286],[110.593672,24.715987],[110.592051,24.717478],[110.591283,24.718896],[110.590767,24.721924],[110.590343,24.723185],[110.590174,24.727168],[110.590603,24.728717],[110.590334,24.729685],[110.588799,24.731452],[110.587475,24.73391],[110.587594,24.734173],[110.589174,24.735596],[110.592315,24.736729],[110.597051,24.73875],[110.59764,24.739676],[110.601645,24.74269],[110.610211,24.743217],[110.620043,24.744452],[110.629874,24.746605],[110.638687,24.749441],[110.648751,24.754352],[110.656272,24.761314],[110.660743,24.771005],[110.66272,24.776073],[110.662921,24.782507],[110.661094,24.789149],[110.658519,24.795787],[110.654665,24.80379],[110.653112,24.807677],[110.652304,24.813643],[110.652752,24.820996],[110.653436,24.829269],[110.653884,24.837313],[110.655103,24.84307],[110.657049,24.851354],[110.660802,24.857132],[110.666076,24.860627],[110.673145,24.86368],[110.67615,24.867379],[110.678141,24.871077],[110.679118,24.87545],[110.67904,24.885094],[110.680118,24.889309],[110.6811,24.893452],[110.683314,24.901737],[110.682776,24.90518],[110.679693,24.911124],[110.674611,24.914296],[110.672565,24.916343],[110.669492,24.919989],[110.668437,24.925259],[110.668168,24.928248],[110.665601,24.932584],[110.662528,24.936921],[110.660231,24.939197],[110.654368,24.944885],[110.653071,24.948085],[110.652523,24.953133],[110.652236,24.957723],[110.651436,24.962771],[110.650619,24.969196],[110.649076,24.972857],[110.647276,24.975366],[110.64498,24.978332],[110.643153,24.984057],[110.642372,24.988184],[110.643596,24.993018],[110.643317,24.995082],[110.64203,24.998056],[110.637436,25.002149],[110.634888,25.005114],[110.632061,25.009452],[110.630522,25.012655],[110.629732,25.015633],[110.631988,25.018869],[110.633984,25.021877],[110.634719,25.025096],[110.634189,25.028764],[110.631376,25.030806],[110.629344,25.032394],[110.626787,25.035588],[110.624472,25.039476],[110.621134,25.044728],[110.620842,25.050238],[110.618526,25.054811],[110.616225,25.05778],[110.610567,25.056975]]]]}}]};
  
  // Helper: ç‚¹æ˜¯å¦åœ¨é—­åˆç¯å†…ï¼ˆå°„çº¿æ³•ï¼‰
  function pointInRing(lon, lat, ring){
    let inside = false;
    for(let i=0, j=ring.length-1; i<ring.length; j=i++){
      const xi = ring[i][0], yi = ring[i][1];
      const xj = ring[j][0], yj = ring[j][1];
      const intersect = ((yi>lat) !== (yj>lat)) && (lon < (xj-xi)*(lat-yi)/(yj-yi) + xi);
      if(intersect) inside = !inside;
    }
    return inside;
  }

  function pointInMultiPolygon(lon, lat, multi){
    if(!multi || !multi.length) return false;
    for(const polygon of multi){
      // polygon is array of rings; first ring is outer
      const outer = polygon[0];
      if(pointInRing(lon, lat, outer)) return true;
    }
    return false;
  }

  function calcGeoCenter(geo){
    try{
      let minx=Infinity,miny=Infinity,maxx=-Infinity,maxy=-Infinity;
      function scanCoords(coords){
        if(!coords) return;
        if(typeof coords[0]==='number' && typeof coords[1]==='number'){
          const x=coords[0], y=coords[1];
          if(isFinite(x)&&isFinite(y)){ minx=Math.min(minx,x); miny=Math.min(miny,y); maxx=Math.max(maxx,x); maxy=Math.max(maxy,y); }
          return;
        }
        for(const c of coords) scanCoords(c);
      }
      for(const f of geo.features||[]) scanCoords(f.geometry && f.geometry.coordinates);
      if(isFinite(minx) && isFinite(miny) && isFinite(maxx) && isFinite(maxy)) return [(minx+maxx)/2,(miny+maxy)/2];
    }catch(e){}
    return [110.494699,24.77534];
  }

  function ensureStationsInside(){
    const feat = (YS_GEO && YS_GEO.features && YS_GEO.features[0]) ? YS_GEO.features[0] : null;
    if(!feat) return;
    const geo = feat.geometry;
    const center = (feat.properties && feat.properties.center) ? feat.properties.center : calcGeoCenter(YS_GEO);
    // è®¡ç®—è¾¹ç•Œç›’
    let minx=Infinity,miny=Infinity,maxx=-Infinity,maxy=-Infinity;
    function scan(coords){
      if(!coords) return;
      if(typeof coords[0]==='number' && typeof coords[1]==='number'){
        minx = Math.min(minx, coords[0]); miny = Math.min(miny, coords[1]); maxx = Math.max(maxx, coords[0]); maxy = Math.max(maxy, coords[1]);
        return;
      }
      for(const c of coords) scan(c);
    }
    for(const f of YS_GEO.features || []) scan(f.geometry && f.geometry.coordinates);
    if(!isFinite(minx) || !isFinite(miny)){
      minx = center[0]-0.1; maxx = center[0]+0.1; miny = center[1]-0.1; maxy = center[1]+0.1;
    }

    function randBetween(a,b){ return a + Math.random()*(b-a); }
    // è¿‘ä¼¼çƒé¢è·ç¦»ï¼ˆç±³ï¼‰â€”â€”haversine
    function haversine(lon1,lat1,lon2,lat2){
      const toRad = Math.PI/180;
      const R = 6371000;
      const dLat = (lat2-lat1)*toRad; const dLon = (lon2-lon1)*toRad;
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    // å·²æ”¾ç½®çš„æœ‰æ•ˆç«™ç‚¹åæ ‡
    function placedCoords(){ return stations.filter(s=>Array.isArray(s.coord)&&s.coord.length>=2).map(s=>({lon:s.coord[0],lat:s.coord[1]})); }

    const existing = placedCoords();
    const minDistMeters = 2200; // æœ€å°é—´è·çº¦ 2.2km

    for(let i=0;i<stations.length;i++){
      const s = stations[i];
      const hasCoord = s.coord && Array.isArray(s.coord) && s.coord.length>=2 && isFinite(s.coord[0]) && isFinite(s.coord[1]);
      let inside = false;
      if(hasCoord){
        const lon = s.coord[0], lat = s.coord[1];
        if(geo.type==='MultiPolygon') inside = pointInMultiPolygon(lon, lat, geo.coordinates);
        else if(geo.type==='Polygon') inside = pointInRing(lon, lat, geo.coordinates[0]);
      }
      // å¯¹äºå·²æœ‰ä¸”åœ¨å¿åŸŸå†…çš„ç«™ç‚¹ï¼Œä¿ç•™ã€‚ä½†è‹¥è·ç¦»è¿‡è¿‘ä¹Ÿä¼šè€ƒè™‘é‡æ–°æ”¾ç½®
      if(hasCoord && inside){
        // æ£€æŸ¥ä¸å·²å­˜åœ¨çš„åæ ‡æ˜¯å¦è¿‡è¿‘ï¼ˆè·³è¿‡è‡ªèº«ï¼‰
        let tooClose = false;
        for(const p of existing){
          if(Math.abs(p.lon - s.coord[0])<1e-6 && Math.abs(p.lat - s.coord[1])<1e-6) continue;
          if(haversine(p.lon,p.lat,s.coord[0],s.coord[1]) < minDistMeters){ tooClose = true; break; }
        }
        if(!tooClose){ existing.push({lon:s.coord[0],lat:s.coord[1]}); continue; }
      }

      // å¦åˆ™é€šè¿‡éšæœºé‡‡æ ·åœ¨å¿åŸŸå†…å¯»æ‰¾åˆé€‚ä½ç½®ï¼Œå¹¶ç¡®ä¿ä¸å…¶ä»–ç«™ç‚¹ä¿æŒæœ€å°è·ç¦»
      let placed = false;
      const maxAttempts = 300;
      for(let attempt=0; attempt<maxAttempts; attempt++){
        const rl = randBetween(minx, maxx);
        const rt = randBetween(miny, maxy);
        // å…ˆåˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
        let ok = false;
        if(geo.type==='MultiPolygon') ok = pointInMultiPolygon(rl, rt, geo.coordinates);
        else if(geo.type==='Polygon') ok = pointInRing(rl, rt, geo.coordinates[0]);
        if(!ok) continue;
        // æ£€æŸ¥ä¸å·²æ”¾ç½®ç«™ç‚¹çš„è·ç¦»
        let tooClose = false;
        for(const p of existing){ if(haversine(p.lon,p.lat,rl,rt) < minDistMeters){ tooClose = true; break; } }
        if(tooClose) continue;
        // é€šè¿‡ï¼Œæ”¾ç½®
        s.coord = [Number(rl.toFixed(6)), Number(rt.toFixed(6))];
        existing.push({lon:s.coord[0],lat:s.coord[1]});
        placed = true; break;
      }
      if(!placed){
        // é€€åŒ–ä¸ºåœ¨ä¸­å¿ƒé™„è¿‘ç½‘æ ¼æ”¾ç½®ï¼ˆé¿å…æ— é™å¤±è´¥ï¼‰
        const col = i % 6; const row = Math.floor(i/6);
        const dx = (col - 2.5) * 0.02; // lon jitter
        const dy = (row - 2) * 0.015;   // lat jitter
        s.coord = [Number((center[0]+dx).toFixed(6)), Number((center[1]+dy).toFixed(6))];
        existing.push({lon:s.coord[0],lat:s.coord[1]});
      }
    }
  }
    const stations = [
      // 12 ä¸ªé æ²³ç«™ï¼ˆç¤ºæ„æ”¾ç½®åœ¨æ¼“æ±Ÿæˆ–æ”¯æµé™„è¿‘ï¼‰
      {id:1, name:'å¤æ´å¡˜', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é‡‘å®ä¹¡å¤æ´å¡˜æ‘', coord:[110.3800,25.0500], type:'é›¨é‡ç«™', level:0},
      {id:2, name:'é¾™æ½­', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é«˜ç”°é•‡é¾™æ½­æ‘', coord:[110.4200,24.9800], type:'æ°´ä½ç«™', level:0},
      {id:3, name:'å…´åª', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿å…´åªé•‡å…´åªæ‘', coord:[110.5531,24.9591], type:'é›¨é‡ç«™', level:0},
      {id:4, name:'é¾™å¤´å±±ç å¤´', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é˜³æœ”é•‡é¾™å¤´å±±ç å¤´', coord:[110.4947,24.7753], type:'æ°´ä½ç«™', level:0},
      {id:5, name:'æ±Ÿæ‘', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿å…´åªé•‡æ±Ÿæ‘', coord:[110.5300,24.7200], type:'æ°´ä½ç«™', level:0},
      {id:6, name:'å¹¸ç¦æºæ°´åº“', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿å…´åªé•‡å¹¸ç¦æºæ°´åº“', coord:[110.5650,24.9550], type:'æ°´åº“', level:0},
      {id:7, name:'é‡‘å®', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é‡‘å®ä¹¡é‡‘å®æ‘', coord:[110.4600,24.7900], type:'é›¨é‡ç«™', level:0},
      {id:8, name:'è§‚æ¡¥', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡è§‚æ¡¥æ‘', coord:[110.4900,24.8000], type:'é›¨é‡ç«™', level:0},
      {id:9, name:'ä»å’Œ', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é«˜ç”°é•‡ä»å’Œæ‘', coord:[110.5000,24.8200], type:'é›¨é‡ç«™', level:0},
      {id:10, name:'ç¬”æ¶å±±', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡ç¬”æ¶å±±æ‘', coord:[110.3500,25.0100], type:'é›¨é‡ç«™', level:0},
      {id:11, name:'åŠè¾¹æœˆ', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç¦åˆ©é•‡åŠè¾¹æœˆæ‘', coord:[110.4500,24.7450], type:'é›¨é‡ç«™', level:0},
      {id:12, name:'å…´éš†', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡å…´éš†æ‘', coord:[110.3420,24.9950], type:'é›¨é‡ç«™', level:0},

      // å…¶ä½™ç«™ç‚¹ï¼šcoord:null ç”± ensureStationsInside() åœ¨ init() æ—¶åˆ†é…åˆ°é˜³æœ”å¿åŸŸå†…ï¼Œè¿‘ä¼¼å‡åŒ€åˆ†å¸ƒ
      {id:13, name:'ç•Œåº•', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é«˜ç”°é•‡ç•Œåº•æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:14, name:'å¤æ¢å¯¨', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡å¤æ¢å¯¨æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:15, name:'é›·å‰æ‘', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é‡‘å®ä¹¡é›·å‰æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:16, name:'é«˜ç”°æ‘', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é«˜ç”°é•‡é«˜ç”°è¡—', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:17, name:'å±±æŠŠå²­', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é‡‘å®ä¹¡å±±æŠŠå²­æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:18, name:'ç™½æ²™', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡ç™½æ²™æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:19, name:'æ€å’Œ', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é«˜ç”°é•‡æ€å’Œæ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:20, name:'è‘¡è„', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿è‘¡è„é•‡è‘¡è„è¡—', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:21, name:'é˜³æœ”ç«™', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é˜³æœ”é•‡æœ¨å±±å¯¨æ‘', coord:null, type:'æ°´æ–‡ç«™', level:0},
      {id:22, name:'æ¯›å®¶', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é‡‘å®ä¹¡æ¯›å®¶æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:23, name:'å¯Œé©¬æ¡¥', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡å¯Œé©¬æ¡¥æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:24, name:'é¾™èƒœ', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç¦åˆ©é•‡é¾™èƒœæ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:25, name:'é¸Ÿå±¿é—¨', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿å…´åªé•‡é¸Ÿå±¿é—¨æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:26, name:'å¤§æ°´ç”°', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿æŸä¹¡å¤§æ°´ç”°æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:27, name:'å®˜å…å²­', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿å…´åªé•‡å®˜å…å²­æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:28, name:'æ¯›å®¶æ¡¥', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿æ¯›å®¶æ¡¥æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:29, name:'ç ¬æ±Ÿ', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é‡‘å®ä¹¡ç ¬æ±Ÿæ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:30, name:'æ±Ÿæ‘2', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿å…´åªé•‡æ±Ÿæ‘(è¡¥å……)', coord:null, type:'æ°´ä½ç«™', level:0},
      {id:31, name:'é¾™å²©é—¨', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿é«˜ç”°é•‡é¾™å²©é—¨æ‘', coord:null, type:'æ°´ä½ç«™', level:0},
      {id:32, name:'å®£é©¬æ¡¥', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿ç™½æ²™é•‡å®£é©¬æ¡¥æ‘', coord:null, type:'é›¨é‡ç«™', level:0},
      {id:33, name:'è¡¥ç«™1', addr:'å¹¿è¥¿æ¡‚æ—å¸‚é˜³æœ”å¿è¡¥å……ç«™1', coord:null, type:'é›¨é‡ç«™', level:0}
    ];

    // æ¼“æ±Ÿé˜³æœ”æ®µï¼ˆLineStringï¼‰åæ ‡åºåˆ—ï¼ˆç»åº¦, çº¬åº¦ï¼‰
    const LIJIANG_COORDS = [
      [110.3800, 25.0500], // è‰åªï¼ˆèµ·ç‚¹ï¼Œåœ°å›¾é¡¶éƒ¨æ¼“æ±Ÿä¸Šæ¸¸å…¥å£ï¼‰
      [110.4200, 24.9800], // æ¨å ¤ä¹¡ï¼ˆæ¼“æ±Ÿè¿›å…¥é˜³æœ”å¿çš„åŒ—å…¥å£ï¼‰
      [110.4500, 24.9700], // ä¸‹é¾™é£å…‰æ®µ
      [110.5531, 24.9591], // å…´åªé•‡ï¼ˆ20å…ƒäººæ°‘å¸èƒŒæ™¯æ ¸å¿ƒæ®µï¼‰
      [110.5300, 24.9000], // é»„å¸ƒå€’å½±æ®µ
      [110.4800, 24.8500], // é˜³æœ”å¿åŸåŒ—æ®µ
      [110.4600, 24.7900], // é˜³æœ”å¿åŸï¼ˆç¢§è²å³°æ²¿å²¸ï¼‰
      [110.4900, 24.7700], // ç¦åˆ©é•‡åŒ—æ®µ
      [110.5000, 24.7500], // ç¦åˆ©é•‡æ²¿å²¸
      [110.5300, 24.7200], // ç•™å…¬æ‘æ®µ
      [110.5500, 24.6800], // æ™®ç›Šä¹¡ï¼ˆé˜³æœ”å¿å—ç«¯å‡ºå£ï¼‰
      [110.6000, 24.6000], // ä¸‹æ¸¸è¿‡æ¸¡æ®µï¼ˆæ™®ç›Šè‡³å¹³ä¹ï¼‰
      // [110.6500, 24.5000]  // å¹³ä¹ï¼ˆç»ˆç‚¹ï¼Œæ¼“æ±Ÿæ±‡å…¥æ¡‚æ±Ÿå¤„ï¼‰
    ];

    // æ”¯æµï¼šå…´åªæ²³
    const XINGPING_HE = [
      [110.5941, 25.1000],
      [110.5900, 25.0380],
      [110.5800, 24.9700],
      [110.5700, 24.9650],
      [110.5600, 24.9600],
      [110.5531, 24.9591],
    ];

    // æ”¯æµï¼šå¹¸ç¦æºæ±Ÿ
    const XINGFUYUAN_JIANG = [
      [110.6331, 25.0221],
      [110.6189, 25.0129],
      [110.6025, 24.9418],
      [110.5903, 24.9452],
      [110.5786, 24.9501],
      [110.5672, 24.9536],
      [110.5589, 24.9568],
      [110.5552, 24.9587]
    ];

    // æ”¯æµï¼šè¥¿å±±æ‘æ²³
    const XISHANCUN_HE = [
      [110.5887, 24.9315],
      [110.5856, 24.9382],
      [110.5778, 24.9357],
      [110.5721, 24.9313],
      [110.5501, 24.9559]
    ];
//æ”¯æµï¼šé‡é¾™æ²³
    const YULONG_HE = [
      [110.3000, 24.9320],
      [110.3520, 24.8976],
      [110.4200, 24.7890],
      [110.4678, 24.6542],
      [110.4980, 24.5600]
    ];
    let simTimer = null;
    let playing = false;
    let selectedStation = stations[0];

    function init(){
      // è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
      
      // æ”¾ç½®ç«™ç‚¹åˆ°å¿åŸŸå†…ï¼ˆè‹¥ coord ä¸º nullï¼Œå°†ç”± ensureStationsInside è°ƒæ•´ï¼‰
      try{ ensureStationsInside(); }catch(e){ console.warn('ensureStationsInside é”™è¯¯', e); }
  // ä¸ºæ¯ä¸ªç«™ç‚¹ç”Ÿæˆåˆå§‹éšæœºæ°´ä½ï¼ˆ0 - 1.8 mï¼‰
  stations.forEach(s=>{ s.level = Number((Math.random()*1.8).toFixed(2)); });
  try{ if(typeof pushDebug==='function') pushDebug('å·²ä¸ºæ‰€æœ‰ç«™ç‚¹ç”Ÿæˆåˆå§‹æ°´ä½'); }catch(e){}
      document.getElementById('nowTime').innerText = new Date().toLocaleString();
      setInterval(()=>document.getElementById('nowTime').innerText=new Date().toLocaleString(),1000);
      renderStationTable();
      initMapCanvas();
      initLevelChart();
      initLevelPercentChart();
      bindControls();
      // æ›´æ–°åœ°å›¾æ•°æ®ä»¥åæ˜ ç«™ç‚¹ä½ç½®å’Œåˆå§‹æ°´ä½
      try{ updateMapData(); }catch(e){ console.warn('updateMapData é”™è¯¯', e); }
    }

    function renderStationTable(){
      const tbody = document.querySelector('#stationTable tbody');
      tbody.innerHTML = '';
      stations.forEach(s=>{
        const tr = document.createElement('tr');
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨é¢„è­¦
        const key = `alert_${s.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"enabled":false}');
        const alertBadge = settings.enabled ? '<span style="display:inline-block;margin-left:4px;padding:2px 6px;background:#ff6b6b;color:#fff;font-size:10px;border-radius:4px;font-weight:bold">âš ï¸</span>' : '';
        
        tr.innerHTML = `<td>${s.name}${alertBadge}</td><td>${s.level.toFixed(2)}</td><td><span class='status-dot' style='background:${statusColor(s.level)}'></span></td>`;
        tr.onclick = ()=>{ selectedStation = s; updateLevelChart(); updateSelectedHeader(s); }
        tbody.appendChild(tr);
      })
      const rtb = document.querySelector('#rainTable tbody');
      rtb.innerHTML='';
      stations.forEach(s=>{ const rtr=document.createElement('tr'); rtr.innerHTML=`<td>${s.name}</td><td>${(Math.random()*20).toFixed(1)}</td>`; rtb.appendChild(rtr) })
      try{ updateLevelPercentChart(); }catch(e){}
    }

    function updateSelectedHeader(sOrName){
      try{
        if(!sOrName) return;
        let s = null;
        if(typeof sOrName === 'string'){
          s = stations.find(ss=>ss.name === sOrName);
        } else {
          s = sOrName;
        }
        if(!s) return;
        // ä¿æŒ selectedStation åŒæ­¥
        selectedStation = s;
        document.getElementById('selName').innerText = s.name;
        document.getElementById('selLevel').innerText = (s.level||0).toFixed(2);
      }catch(e){}
    }

    function statusColor(level){
      if(level>1.4) return '#e74c3c';
      if(level>1.1) return '#f1c40f';
      return '#2ecc71';
    }

    // æŠ˜å é€»è¾‘ï¼šåˆ‡æ¢å¡ç‰‡çš„ collapsed ç±»å¹¶åœ¨ localStorage ä¸­ä¿å­˜çŠ¶æ€
    function toggleCard(id){
      try{
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.toggle('collapsed');
        const collapsed = el.classList.contains('collapsed');
        localStorage.setItem('card_collapsed_'+id, collapsed? '1':'0');
        // æ›´æ–°æŒ‰é’®ç¬¦å·
        const btn = el.querySelector('.collapse-btn');
        if(btn) btn.textContent = collapsed ? 'â–¸' : 'â–¾';
      }catch(e){ }
    }

    function restoreCardStates(){
      ['stationCard','rainCard'].forEach(id=>{
        try{
          const el = document.getElementById(id);
          if(!el) return;
          const val = localStorage.getItem('card_collapsed_'+id);
          const collapsed = val === '1';
          if(collapsed) el.classList.add('collapsed');
          const btn = el.querySelector('.collapse-btn');
          if(btn) btn.textContent = collapsed ? 'â–¸' : 'â–¾';
        }catch(e){}
      })
    }

    // ä½¿ç”¨ ECharts åœ°å›¾ï¼šä¼˜å…ˆæ¸²æŸ“æ¡‚æ—å¸‚åº•å›¾å¹¶å¯¹é˜³æœ”å¿åŠ æ·±ï¼ˆéœ€è¦åŒç›®å½•ä¸‹æœ‰ æ¡‚æ—å¸‚.jsonï¼‰ï¼›
    // è‹¥ç¼ºå¤±åˆ™å›é€€åˆ°é˜³æœ”å¿è¾¹ç•Œï¼ˆåŒç›®å½•ä¸‹çš„ é˜³æœ”å¿.json æˆ–å†…åµŒ YS_GEOï¼‰ã€‚
    let mapChart = null;
    function initMapCanvas(){
      const el = document.getElementById('mapCanvas');
      el.style.left = '0'; el.style.top = '0'; el.style.right='0'; el.style.bottom='0';
      el.style.position='absolute';
      // åˆ›å»º echarts å®ä¾‹
      mapChart = echarts.init(el);
      // è½½å…¥ GeoJSON å¹¶æ³¨å†Œä¸ºåœ°å›¾
      // å·¥å…·ï¼šè®¡ç®—ä»»æ„ GeoJSON çš„è¿‘ä¼¼ä¸­å¿ƒï¼ˆæ‰«ææ‰€æœ‰åæ ‡çš„åŒ…å›´ç›’ä¸­å¿ƒï¼‰
      function calcCenter(geo){
        try{
          let minx=Infinity,miny=Infinity,maxx=-Infinity,maxy=-Infinity;
          function scanCoords(coords){
            if(!coords) return;
            if(typeof coords[0]==='number' && typeof coords[1]==='number'){
              const x=coords[0], y=coords[1];
              if(isFinite(x)&&isFinite(y)){ minx=Math.min(minx,x); miny=Math.min(miny,y); maxx=Math.max(maxx,x); maxy=Math.max(maxy,y); }
              return;
            }
            for(const c of coords){ scanCoords(c); }
          }
          for(const f of geo.features||[]){ scanCoords(f.geometry && f.geometry.coordinates); }
          if(isFinite(minx)&&isFinite(miny)&&isFinite(maxx)&&isFinite(maxy)){
            return [(minx+maxx)/2,(miny+maxy)/2];
          }
        }catch(e){}
        return [110.494699,24.77534];
      }

      // ä½¿ç”¨æ¡‚æ—å¸‚åº•å›¾ï¼šé«˜äº®é˜³æœ”å¿
      const useCity = (cityGeo)=>{
        // 1) ä¾¦æµ‹ GeoJSON ä½¿ç”¨çš„åç§°å­—æ®µï¼Œå¸¸è§ï¼šname | NAME_CHN | NAME | fullname | NAME_ZH
        function detectNameKey(geo){
          const keys = ['name','NAME_CHN','NAME','fullname','NAME_ZH','Name'];
          const feats = geo && geo.features || [];
          for(const k of keys){
            if(feats.some(f=>f && f.properties && typeof f.properties[k]==='string' && f.properties[k].length>0)){
              return k;
            }
          }
          return 'name';
        }
        const nameKey = detectNameKey(cityGeo);
        // 2) åœ¨æ³¨å†Œæ—¶å‘ŠçŸ¥ ECharts ç”¨å“ªä¸ªå±æ€§ä½œä¸ºåŒºåŸŸåç§°
        echarts.registerMap('guilin', cityGeo, { nameProperty: nameKey });
        // 3) æŸ¥æ‰¾â€œé˜³æœ”â€å¯¹åº”çš„åŒºåŸŸåï¼ˆè‹¥åç§°è‹±æ–‡åŒ–åˆ™åŒ¹é… yangshuoï¼‰
        function findYangshuoName(geo, k){
          const feats = geo && geo.features || [];
          const target = feats.find(f=>{
            const val = f && f.properties && f.properties[k];
            if(typeof val !== 'string') return false;
            const s = val.toLowerCase();
            return s.includes('é˜³æœ”') || s.includes('yangshuo');
          });
          return target && target.properties && target.properties[k];
        }
        const yangshuoName = findYangshuoName(cityGeo, nameKey) || 'é˜³æœ”å¿';

        const center = (cityGeo.features && cityGeo.features[0] && cityGeo.features[0].properties && cityGeo.features[0].properties.center) ? cityGeo.features[0].properties.center : calcCenter(cityGeo);
        const option = {
          tooltip:{trigger:'item',formatter: function(params){ if(params.seriesType==='scatter'){ return params.name + '<br/>æ°´ä½: ' + (params.value[2]||'--') + ' m' } return params.name;}},
          geo:{ map:'guilin', roam:true, label:{show:false},
            itemStyle:{areaColor:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:'#0b5260'},{offset:1,color:'#04282d'}]},borderColor:'#0fbfc6',borderWidth:1,shadowColor:'rgba(0,0,0,0.5)',shadowBlur:20,opacity:0.95},
            // åˆå§‹ä¸­å¿ƒä¸ç¼©æ”¾
            center:center, zoom:6,
            // å¯¹ç‰¹å®šåŒºå¿åŠ æ·±æ ·å¼ï¼šé˜³æœ”å¿ï¼ˆåŠ æ·±å¡«å……ã€åŠ ç²—æè¾¹ï¼Œå¹¶æ˜¾ç¤ºæ ‡ç­¾ï¼‰
            regions:[{ 
              name: yangshuoName, 
              itemStyle:{ areaColor:'#006e7a', borderColor:'#11e5f0', borderWidth:2 },
              label:{ show:true, color:'#e8fdff', fontWeight:'bold' },
              emphasis:{ itemStyle:{ areaColor:'#008d99' }, label:{ show:true, color:'#ffffff' } }
            }]
          },
          series:[
            { name:'ç«™ç‚¹', type:'scatter', coordinateSystem:'geo', symbolSize:12, encode:{value:2}, data: stations.map(s=>({name:s.name,value:[s.coord[0],s.coord[1],s.level]})),
              itemStyle:{color:function(params){ const v = params.value && params.value[2]; if(v>1.4) return '#ff6b6b'; if(v>1.1) return '#ffd86b'; return '#6be29a'}}, label:{show:false}
            },
            // é«˜äº®è¶…è­¦ç«™ç‚¹çš„è„‰å†²æ•ˆæœ
            { name:'å‘Šè­¦', type:'effectScatter', coordinateSystem:'geo', symbolSize:16, showEffectOn:'render', rippleEffect:{brushType:'stroke',scale:3},
              data: stations.filter(s=>s.level>1.4).map(s=>({name:s.name,value:[s.coord[0],s.coord[1],s.level]})),
              itemStyle:{color:'#ff6b6b'},
              zlevel: 10
            }
            ,
            // æ¼“æ±Ÿçº¿è·¯ï¼Œä½¿ç”¨ lines + effect æ¥è¡¨ç°æµåŠ¨æ„Ÿ
            {
              name: 'æ¼“æ±Ÿ',
              type: 'lines',
              coordinateSystem: 'geo',
              zlevel: 5,
              effect: { show: true, period: 6, trailLength: 0.7, color: '#a6ecff', symbol: 'arrow', symbolSize: 8 },
              lineStyle: { color: '#4dd0e1', width: 3, opacity: 0.8, curveness: 0.2 },
              // è½¬æ¢ä¸º lines æ‰€éœ€çš„ [[from,to],[from2,to2],...] æˆ– [[coords array]] ç»“æ„
              data: (function(){
                // å°†è¿ç»­åæ ‡è½¬æ¢ä¸ºå¤šæ®µ linesï¼ˆæ¯æ®µä¸º [from,to]ï¼‰
                const arr = [];
                for(let i=0;i<LIJIANG_COORDS.length-1;i++){
                  arr.push({coords:[LIJIANG_COORDS[i], LIJIANG_COORDS[i+1]]});
                }
                return arr;
              })()
            }
              ,
              // å…´åªæ²³
              {
                name: 'å…´åªæ²³',
                type: 'lines',
                coordinateSystem: 'geo',
                zlevel: 6,
                effect: { show: true, period: 4, trailLength: 0.6, color: '#9fe6a0', symbol: 'arrow', symbolSize: 6 },
                lineStyle: { color: '#7bd389', width: 2.5, opacity: 0.9, curveness: 0.1 },
                data: (function(){ const arr=[]; for(let i=0;i<XINGPING_HE.length-1;i++){ arr.push({coords:[XINGPING_HE[i], XINGPING_HE[i+1]]}); } return arr })()
              }
              ,
              // å¹¸ç¦æºæ±Ÿ
              {
                name: 'å¹¸ç¦æºæ±Ÿ',
                type: 'lines',
                coordinateSystem: 'geo',
                zlevel: 6,
                effect: { show: true, period: 5, trailLength: 0.6, color: '#ffd4a6', symbol: 'arrow', symbolSize: 6 },
                lineStyle: { color: '#ffb36b', width: 2.5, opacity: 0.85, curveness: 0.1 },
                data: (function(){ const arr=[]; for(let i=0;i<XINGFUYUAN_JIANG.length-1;i++){ arr.push({coords:[XINGFUYUAN_JIANG[i], XINGFUYUAN_JIANG[i+1]]}); } return arr })()
              }
              ,
              // è¥¿å±±æ‘æ²³
              {
                name: 'è¥¿å±±æ‘æ²³',
                type: 'lines',
                coordinateSystem: 'geo',
                zlevel: 6,
                effect: { show: true, period: 4.5, trailLength: 0.6, color: '#b6d8ff', symbol: 'arrow', symbolSize: 6 },
                lineStyle: { color: '#88b7ff', width: 2.5, opacity: 0.9, curveness: 0.1 },
                data: (function(){ const arr=[]; for(let i=0;i<XISHANCUN_HE.length-1;i++){ arr.push({coords:[XISHANCUN_HE[i], XISHANCUN_HE[i+1]]}); } return arr })()
              }
            ,
           //é‡é¾™æ²³
            {
                name: 'é‡é¾™æ²³',
                type: 'lines',
                coordinateSystem: 'geo',
                zlevel: 6,
                effect: { show: true, period: 4.5, trailLength: 0.6, color: '#ff1493', symbol: 'arrow', symbolSize: 6 },
                lineStyle: { color: '#fce4ec', width: 2.5, opacity: 0.85, curveness: 0.1 },
                data: (function(){ const arr=[]; for(let i=0;i<YULONG_HE.length-1;i++){ arr.push({coords:[YULONG_HE[i], YULOMG_HE[i+1]]}); } return arr })()
              }
          ]
          
        };
        // ç¡®ä¿åœ°å›¾å®¹å™¨å…è®¸äº¤äº’
        try{ mapChart.getDom().style.pointerEvents = 'auto'; }catch(e){}

  mapChart.setOption(option);
  // ç‚¹å‡»ç«™ç‚¹äº¤äº’ï¼ˆåŸå¸‚åº•å›¾ï¼‰
  try{ mapChart.on('click', function(params){ if(params.seriesType==='scatter' || params.seriesType==='effectScatter'){ const s = stations.find(ss=>ss.name===params.name); if(s){ selectedStation = s; updateLevelChart(); updateSelectedHeader(s); showPopup(s); } } }); }catch(e){}
        // åˆå§‹è§†å›¾ï¼šæ˜ç¡®è®¾ç½® center ä¸ zoomï¼Œé¿å…æ¸²æŸ“æ—¶æœºé—®é¢˜å¯¼è‡´ä¸å±…ä¸­
        try{
          const c = (cityGeo.features && cityGeo.features[0] && cityGeo.features[0].properties && cityGeo.features[0].properties.center) ? cityGeo.features[0].properties.center : null;
          if(c){
            mapChart.setOption({ geo: { center: c, zoom: 6 } });
            // åœ¨æ¸²æŸ“å®Œæˆåå¼ºåˆ¶ä¸€æ¬¡ resizeï¼Œé¿å…å®¹å™¨å°ºå¯¸æˆ–æ¸²æŸ“å»¶è¿Ÿå¯¼è‡´çš„åç§»
            setTimeout(()=>{ try{ mapChart.resize(); }catch(e){} }, 80);
          }
        }catch(e){ /* ignore */ }
        // ç‚¹å‡»ç«™ç‚¹äº¤äº’
        mapChart.on('click', function(params){ if(params.seriesType==='scatter' || params.seriesType==='effectScatter'){ const s = stations.find(ss=>ss.name===params.name); if(s){ selectedStation = s; updateLevelChart(); showPopup(s); } } });
      };

      // ä½¿ç”¨å›é€€ï¼šä»…æœ‰é˜³æœ”å¿æ—¶ï¼ˆç»´æŒç°æœ‰é€»è¾‘ï¼‰
      const useCounty = (geo)=>{
        echarts.registerMap('yangshuo', geo);
        const center = (geo.features && geo.features[0] && geo.features[0].properties && geo.features[0].properties.center) ? geo.features[0].properties.center : [110.494699,24.77534];
        const option = {
          tooltip:{trigger:'item',formatter: function(params){ if(params.seriesType==='scatter'){ return params.name + '<br/>æ°´ä½: ' + (params.value[2]||'--') + ' m' } return params.name;}},
          geo:{ map:'yangshuo', roam:true, label:{show:false},
            itemStyle:{areaColor:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:'#0b5260'},{offset:1,color:'#04282d'}]},borderColor:'#0fbfc6',borderWidth:1,shadowColor:'rgba(0,0,0,0.5)',shadowBlur:20,opacity:0.95},
            center:center, zoom:6
          },
          series:[
            { name:'ç«™ç‚¹', type:'scatter', coordinateSystem:'geo', symbolSize:12, encode:{value:2}, data: stations.map(s=>({name:s.name,value:[s.coord[0],s.coord[1],s.level]})),
              itemStyle:{color:function(params){ const v = params.value && params.value[2]; if(v>1.4) return '#ff6b6b'; if(v>1.1) return '#ffd86b'; return '#6be29a'}}, label:{show:false}
            },
            { name:'å‘Šè­¦', type:'effectScatter', coordinateSystem:'geo', symbolSize:16, showEffectOn:'render', rippleEffect:{brushType:'stroke',scale:3},
              data: stations.filter(s=>s.level>1.4).map(s=>({name:s.name,value:[s.coord[0],s.coord[1],s.level]})),
              itemStyle:{color:'#ff6b6b'},
              zlevel: 10
            },
            {
              name: 'æ¼“æ±Ÿ', type: 'lines', coordinateSystem: 'geo', zlevel: 5,
              effect: { show: true, period: 6, trailLength: 0.7, color: '#a6ecff', symbol: 'arrow', symbolSize: 8 },
              lineStyle: { color: '#4dd0e1', width: 3, opacity: 0.8, curveness: 0.2 },
              data: (function(){ const arr=[]; for(let i=0;i<LIJIANG_COORDS.length-1;i++){ arr.push({coords:[LIJIANG_COORDS[i], LIJIANG_COORDS[i+1]]}); } return arr; })()
            },
            { name:'å…´åªæ²³', type:'lines', coordinateSystem:'geo', zlevel:6,
              effect:{ show:true, period:4, trailLength:0.6, color:'#9fe6a0', symbol:'arrow', symbolSize:6 },
              lineStyle:{ color:'#7bd389', width:2.5, opacity:0.9, curveness:0.1 },
              data:(function(){ const arr=[]; for(let i=0;i<XINGPING_HE.length-1;i++){ arr.push({coords:[XINGPING_HE[i], XINGPING_HE[i+1]]}); } return arr })()
            },
            { name:'å¹¸ç¦æºæ±Ÿ', type:'lines', coordinateSystem:'geo', zlevel:6,
              effect:{ show:true, period:5, trailLength:0.6, color:'#ffd4a6', symbol:'arrow', symbolSize:6 },
              lineStyle:{ color:'#ffb36b', width:2.5, opacity:0.85, curveness:0.1 },
              data:(function(){ const arr=[]; for(let i=0;i<XINGFUYUAN_JIANG.length-1;i++){ arr.push({coords:[XINGFUYUAN_JIANG[i], XINGFUYUAN_JIANG[i+1]]}); } return arr })()
            },
            { name:'è¥¿å±±æ‘æ²³', type:'lines', coordinateSystem:'geo', zlevel:6,
              effect:{ show:true, period:4.5, trailLength:0.6, color:'#b6d8ff', symbol:'arrow', symbolSize:6 },
              lineStyle:{ color:'#88b7ff', width:2.5, opacity:0.9, curveness:0.1 },
              data:(function(){ const arr=[]; for(let i=0;i<XISHANCUN_HE.length-1;i++){ arr.push({coords:[XISHANCUN_HE[i], XISHANCUN_HE[i+1]]}); } return arr })()
            },
            { name:'é‡é¾™æ²³', type:'lines', coordinateSystem:'geo', zlevel:6,
              effect:{ show:true, period:4.5, trailLength:0.6, color:'#ff1493', symbol:'arrow', symbolSize:6 },
              lineStyle:{ color:'#fce4ec', width:2.5, opacity:0.85, curveness:0.1 },
              data:(function(){ const arr=[]; for(let i=0;i<YULONG_HE.length-1;i++){ arr.push({coords:[YULONG_HE[i], YULONG_HE[i+1]]}); } return arr })()
            }
          ]
        };
        try{ mapChart.getDom().style.pointerEvents = 'auto'; }catch(e){}
  mapChart.setOption(option);
  // ç‚¹å‡»ç«™ç‚¹äº¤äº’ï¼ˆå¿åŸŸåº•å›¾ï¼‰
  try{ mapChart.on('click', function(params){ if(params.seriesType==='scatter' || params.seriesType==='effectScatter'){ const s = stations.find(ss=>ss.name===params.name); if(s){ selectedStation = s; updateLevelChart(); updateSelectedHeader(s); showPopup(s); } } }); }catch(e){}
      };

      // ä¼˜å…ˆä½¿ç”¨å†…è”çš„ GUILIN_GEOï¼ˆé€‚ç”¨äº file:// ç›´æ¥æ‰“å¼€çš„åœºæ™¯ï¼‰ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä½¿ç”¨ fetch åŠ è½½æœ¬åœ°æ–‡ä»¶ï¼Œå¤±è´¥å†å›é€€åˆ°é˜³æœ”æˆ–å†…åµŒ YS_GEOã€‚
      (function loadGuilin(){
        function fetchCity(){
          return fetch('./æ¡‚æ—å¸‚.json')
            .then(r=>r.json())
            .then(city => { useCity(city); return city; })
            .catch(err => {
              console.warn('æœªæ‰¾åˆ° æ¡‚æ—å¸‚.jsonï¼Œå°†å›é€€åˆ°é˜³æœ”å¿è¾¹ç•Œã€‚', err);
              return fetch('./é˜³æœ”å¿.json').then(r=>r.json()).then(geo => { useCounty(geo); return geo; }).catch(e2=>{ console.warn('fetch é˜³æœ”å¿.json å¤±è´¥ï¼Œä½¿ç”¨å†…åµŒ Geoï¼š', e2); useCounty(YS_GEO); return YS_GEO; });
            });
        }

        try{
          if(typeof GUILIN_GEO !== 'undefined' && GUILIN_GEO && GUILIN_GEO.features){
            // ä½¿ç”¨å†…è”å˜é‡ï¼ˆæ›´å¿«ä¸”æ”¯æŒ file://ï¼‰
            try{ useCity(GUILIN_GEO); return; }catch(e){ console.warn('å†…è” GUILIN_GEO ä½¿ç”¨å¤±è´¥ï¼Œå°è¯•é€šè¿‡ fetch åŠ è½½ï¼š', e); }
          }
        }catch(e){ /* ignore */ }

        // å¦åˆ™å°è¯• fetch
        fetchCity();
      })();
      
      // å“åº”çª—å£å°ºå¯¸
      window.addEventListener('resize', ()=>{ if(mapChart) mapChart.resize(); })
    }

    function showPopup(s){
      // éªŒè¯è¾“å…¥
      if (!s) {
        console.error('showPopup: æ— æ•ˆçš„ç«™ç‚¹å¯¹è±¡', s);
        alert('âŒ ç«™ç‚¹æ•°æ®æ— æ•ˆ');
        return;
      }
      
      if (!s.name || !s.level || !s.coord || !s.addr || !s.type) {
        console.error('showPopup: ç«™ç‚¹æ•°æ®ä¸å®Œæ•´', s);
        alert('âŒ ç«™ç‚¹æ•°æ®ä¸å®Œæ•´');
        return;
      }
      
      console.log('showPopup: æ‰“å¼€å¼¹çª— -', s.name, 'å½“å‰æ°´ä½:', s.level);
      
      const el = document.createElement('div'); 
      el.className='card'; 
      el.style.position='fixed'; 
      el.style.left='50%'; 
      el.style.top='50%'; 
      el.style.transform='translate(-50%,-50%)'; 
      el.style.zIndex=9999;
      el.style.maxWidth='650px';
      el.style.minWidth='500px';
      el.style.maxHeight='90vh';
      el.style.overflow='auto';
      el.style.backgroundColor='#041729';
      el.style.borderRadius='8px';
      el.style.boxShadow='0 20px 60px rgba(0,0,0,0.8)';
      
      // åˆ›å»ºé®ç½©èƒŒæ™¯
      const mask = document.createElement('div');
      mask.style.position='fixed';
      mask.style.top='0';
      mask.style.left='0';
      mask.style.right='0';
      mask.style.bottom='0';
      mask.style.backgroundColor='rgba(0,0,0,0.6)';
      mask.style.zIndex=9998;
      mask.style.cursor='pointer';
      mask.onclick = () => {
        console.log('ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—');
        // æ³¨æ„ï¼štrendChart ä¼šåœ¨åé¢åˆå§‹åŒ–ï¼Œè¿™é‡Œå…ˆä¿æŒç©ºå®ç°
        if (typeof trendChart !== 'undefined' && trendChart) {
          trendChart.dispose();
        }
        el.remove();
        mask.remove();
      };
      
      // ç”Ÿæˆå†å²å’Œé¢„æµ‹æ•°æ®
      const historyData = [];
      const forecastData = [];
      const now = Date.now();
      
      // è¿‡å»24å°æ—¶æ•°æ®ï¼ˆæ¯å°æ—¶ä¸€ä¸ªç‚¹ï¼‰
      for(let i = 24; i >= 0; i--) {
        const time = new Date(now - i * 3600 * 1000);
        const value = s.level + (Math.random() - 0.5) * 0.3;
        historyData.push({
          time: time.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}),
          value: Math.max(0, value).toFixed(2)
        });
      }
      
      // æœªæ¥24å°æ—¶é¢„æµ‹æ•°æ®
      for(let i = 1; i <= 24; i++) {
        const time = new Date(now + i * 3600 * 1000);
        const trend = (Math.random() - 0.45) * 0.1; // ç•¥æœ‰ä¸‹é™è¶‹åŠ¿
        const value = parseFloat(historyData[historyData.length - 1].value) + trend * i;
        forecastData.push({
          time: time.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}),
          value: Math.max(0, value).toFixed(2)
        });
      }
      
      // è·å–å½“å‰é¢„è­¦è®¾ç½®
      const alertSettings = JSON.parse(localStorage.getItem('alertSettings') || '{}');
      const stationAlert = alertSettings[s.name] || {threshold: 1.4, rateThreshold: 0.1};
      
      el.innerHTML = `
        <div style="padding:20px;color:#c9f3ff;font-family:Arial,sans-serif">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid rgba(15,191,198,0.3);padding-bottom:15px">
            <h2 style="margin:0;font-size:24px;color:#0fbfc6">${s.name}</h2>
            <button id='closePop' style="padding:6px 16px;border-radius:4px;background:#e74c3c;color:#fff;border:none;cursor:pointer;font-weight:bold;font-size:14px">å…³é—­</button>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
            <div style="background:rgba(15,191,198,0.1);padding:12px;border-radius:6px;border-left:3px solid #0fbfc6">
              <div style="color:#9fead6;font-size:12px;margin-bottom:5px">å½“å‰æ°´ä½</div>
              <div style="font-size:28px;font-weight:bold;color:#0fbfc6">${s.level.toFixed(2)} m</div>
            </div>
            <div style="background:rgba(15,191,198,0.1);padding:12px;border-radius:6px;border-left:3px solid #0fbfc6">
              <div style="color:#9fead6;font-size:12px;margin-bottom:5px">çŠ¶æ€</div>
              <div style="font-size:20px;font-weight:bold"><span style='color:${statusColor(s.level)};font-size:14px'>â—</span> <span style='color:${statusColor(s.level)}'>${s.level > 1.4 ? 'è¶…è­¦' : s.level > 1.1 ? 'è­¦æˆ’' : 'æ­£å¸¸'}</span></div>
            </div>
          </div>
          
          <div style="background:rgba(15,191,198,0.05);padding:15px;border-radius:6px;margin-bottom:20px;border:1px solid rgba(15,191,198,0.2)">
            <div style="font-weight:bold;margin-bottom:12px;color:#0fbfc6;font-size:16px">âš™ï¸ é¢„è­¦è®¾ç½®</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
              <div>
                <label style="font-size:12px;color:#9fead6;display:block;margin-bottom:6px">æ°´ä½é˜ˆå€¼ (m)</label>
                <input type="number" id="thresholdInput" value="${stationAlert.threshold}" step="0.1" min="0" max="5"
                  style="width:100%;padding:8px;border-radius:4px;border:1px solid #0fbfc6;background:#041729;color:#c9f3ff;box-sizing:border-box">
              </div>
              <div>
                <label style="font-size:12px;color:#9fead6;display:block;margin-bottom:6px">ä¸Šå‡é€Ÿç‡é˜ˆå€¼ (m/h)</label>
                <input type="number" id="rateInput" value="${stationAlert.rateThreshold}" step="0.01" min="0" max="1"
                  style="width:100%;padding:8px;border-radius:4px;border:1px solid #0fbfc6;background:#041729;color:#c9f3ff;box-sizing:border-box">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <button id="saveAlertBtn" style="padding:10px;border-radius:4px;background:linear-gradient(135deg,#0fbfc6,#0d9ba6);color:#041729;border:none;cursor:pointer;font-weight:bold;font-size:14px;transition:all 0.3s">
                ğŸ’¾ ä¿å­˜è®¾ç½®
              </button>
              <button id="confirmBtn" style="padding:10px;border-radius:4px;background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff;border:none;cursor:pointer;font-weight:bold;font-size:14px;transition:all 0.3s">
                âœ… ç¡®å®š
              </button>
            </div>
          </div>
          
          <div style="margin-bottom:20px">
            <div style="font-weight:bold;margin-bottom:12px;color:#0fbfc6;font-size:16px">ğŸ“ˆ æ°´ä½èµ°åŠ¿</div>
            <div id="trendChart" style="width:100%;height:280px;background:rgba(0,0,0,0.3);border-radius:6px;border:1px solid rgba(15,191,198,0.2)"></div>
          </div>
          
          <div style="background:rgba(15,191,198,0.05);padding:12px;border-radius:6px;border:1px solid rgba(15,191,198,0.2);font-size:12px;color:#9fead6;line-height:1.8">
            <div>ğŸ“ <strong>åœ°å€</strong>ï¼š${s.addr}</div>
            <div>ğŸ·ï¸ <strong>ç±»å‹</strong>ï¼š${s.type}</div>
            <div>ğŸ¯ <strong>åæ ‡</strong>ï¼š${s.coord[0].toFixed(4)}, ${s.coord[1].toFixed(4)}</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(mask);
      document.body.appendChild(el);
      
      // åˆå§‹åŒ–è¶‹åŠ¿å›¾è¡¨
      const trendChart = echarts.init(document.getElementById('trendChart'));
      const allTimes = [...historyData.map(d => d.time), ...forecastData.map(d => d.time)];
      const allValues = [...historyData.map(d => parseFloat(d.value)), ...forecastData.map(d => parseFloat(d.value))];
      
      trendChart.setOption({
        grid: { left: 50, right: 20, top: 40, bottom: 30 },
        tooltip: {
          trigger: 'axis',
          formatter: function(params) {
            const idx = params[0].dataIndex;
            const isForecast = idx >= historyData.length;
            return `${params[0].axisValue}<br/>${isForecast ? 'é¢„æµ‹' : 'å®æµ‹'}æ°´ä½ï¼š${params[0].data} m`;
          }
        },
        xAxis: {
          type: 'category',
          data: allTimes,
          axisLabel: { interval: 5, rotate: 45, fontSize: 10, color: '#9fead6' },
          axisLine: { lineStyle: { color: '#0fbfc6' } }
        },
        yAxis: {
          type: 'value',
          name: 'æ°´ä½(m)',
          nameTextStyle: { color: '#9fead6' },
          axisLabel: { color: '#9fead6' },
          axisLine: { lineStyle: { color: '#0fbfc6' } },
          splitLine: { lineStyle: { color: 'rgba(15,191,198,0.1)' } }
        },
        visualMap: {
          show: false,
          pieces: [
            { gt: 0, lte: 1.1, color: '#2ecc71' },
            { gt: 1.1, lte: 1.4, color: '#f1c40f' },
            { gt: 1.4, color: '#e74c3c' }
          ]
        },
        series: [
          {
            name: 'æ°´ä½',
            type: 'line',
            data: allValues,
            smooth: true,
            lineStyle: { width: 2 },
            areaStyle: { opacity: 0.3 },
            markLine: {
              data: [
                { yAxis: stationAlert.threshold, name: 'é¢„è­¦çº¿', lineStyle: { color: '#e74c3c', type: 'dashed' } }
              ],
              label: { formatter: 'é¢„è­¦çº¿ {c}m' }
            },
            markArea: {
              data: [[
                { xAxis: historyData[historyData.length - 1].time, itemStyle: { color: 'rgba(255,255,255,0.05)' } },
                { xAxis: forecastData[forecastData.length - 1].time }
              ]],
              label: { show: true, position: 'top', formatter: 'é¢„æµ‹åŒºåŸŸ', color: '#ffd86b' }
            }
          }
        ]
      });
      
      // å…³é—­æŒ‰é’®
      document.getElementById('closePop').onclick = () => {
        console.log('å…³é—­è¶‹åŠ¿å¼¹çª—');
        trendChart.dispose();
        el.remove();
        mask.remove();
      };
      
      // ç¡®å®šæŒ‰é’® - ç›´æ¥å…³é—­å¼¹çª—ï¼ˆä¸éœ€è¦ä¿å­˜è®¾ç½®ï¼‰
      document.getElementById('confirmBtn').onclick = () => {
        console.log('ç‚¹å‡»ç¡®å®šæŒ‰é’®ï¼Œå…³é—­å¼¹çª—');
        trendChart.dispose();
        el.remove();
        mask.remove();
      };
      
      // ä¿å­˜é¢„è­¦è®¾ç½®æŒ‰é’®
      document.getElementById('saveAlertBtn').onclick = () => {
        const threshold = parseFloat(document.getElementById('thresholdInput').value);
        const rateThreshold = parseFloat(document.getElementById('rateInput').value);
        
        if (isNaN(threshold) || isNaN(rateThreshold)) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
          return;
        }
        
        if (threshold < 0 || threshold > 5 || rateThreshold < 0 || rateThreshold > 1) {
          alert('æ°´ä½é˜ˆå€¼èŒƒå›´ï¼š0-5m\nä¸Šå‡é€Ÿç‡èŒƒå›´ï¼š0-1m/h');
          return;
        }
        
        // ä¿å­˜åˆ° localStorage ä¸­çš„ç«™ç‚¹çº§åˆ«é¢„è­¦è®¾ç½®
        const key = `alert_${s.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
        settings.threshold = threshold;
        settings.rateThreshold = rateThreshold;
        localStorage.setItem(key, JSON.stringify(settings));
        
        // ä¹Ÿä¿å­˜åˆ°æ—§çš„æ ¼å¼ï¼ˆå…¼å®¹æ€§ï¼‰
        const alertSettings = JSON.parse(localStorage.getItem('alertSettings') || '{}');
        alertSettings[s.name] = { threshold, rateThreshold };
        localStorage.setItem('alertSettings', JSON.stringify(alertSettings));
        
        alert(`âœ… å·²ä¿å­˜ ${s.name} çš„é¢„è­¦è®¾ç½®\næ°´ä½é˜ˆå€¼ï¼š${threshold}m\nä¸Šå‡é€Ÿç‡ï¼š${rateThreshold}m/h`);
        
        // æ›´æ–°å›¾è¡¨ä¸­çš„é¢„è­¦çº¿
        trendChart.setOption({
          series: [{
            markLine: {
              data: [{ yAxis: threshold, name: 'é¢„è­¦çº¿', lineStyle: { color: '#e74c3c', type: 'dashed' } }]
            }
          }]
        });
      };
    }

    // ECharts æ°´ä½æŠ˜çº¿å›¾
    let levelChart = null;
    function initLevelChart(){
      levelChart = echarts.init(document.getElementById('levelChart'));
      updateLevelChart();
    }
    function updateLevelChart(){
      const now = +new Date();
      const data = [];
      let base = now - 3600*1000;
      for(let i=0;i<24;i++){ data.push([new Date(base+ i*5*60*1000).toLocaleTimeString(), (selectedStation.level + (Math.random()-0.5)*0.2).toFixed(2)]) }
      const option = {
        xAxis:{type:'category',data:data.map(d=>d[0])},
        yAxis:{type:'value',min:0},
        series:[{type:'line',data:data.map(d=>d[1]),smooth:true,areaStyle:{color:'rgba(46,204,113,0.08)'}}]
      };
      levelChart.setOption(option);
    }

    function bindControls(){
      document.getElementById('playBtn').onclick = ()=>{ if(playing) return; playing=true; simStart() }
      document.getElementById('pauseBtn').onclick = ()=>{ playing=false; if(simTimer){ clearInterval(simTimer); simTimer=null } }
    }

    // æ°´ä½æ­£å¸¸æ¯”ä¾‹å›¾ï¼ˆåœ†ç¯ï¼‰
    let levelPercentChart = null;
    function initLevelPercentChart(){
      try{
        const el = document.getElementById('levelPercentChart');
        if(!el) return;
        levelPercentChart = echarts.init(el);
        updateLevelPercentChart();
      }catch(e){ console.warn('initLevelPercentChart å¤±è´¥', e); }
    }
    function updateLevelPercentChart(){
      if(!levelPercentChart) return;
      const total = stations.length;
      const normal = stations.filter(s=>s.level<=1.1).length;
      const warn = stations.filter(s=>s.level>1.1 && s.level<=1.4).length;
      const alarm = stations.filter(s=>s.level>1.4).length;
      const option = {
        tooltip:{show:true,formatter:'{b}: {d}%'},
        series:[{
          type:'pie',radius:['50%','75%'],avoidLabelOverlap:false,center:['50%','50%'],
          label:{show:true,position:'center',formatter:`{a|æ­£å¸¸ ${normal}/${total}\n}{b|${Math.round((normal/total)*100)}%}`,rich:{a:{fontSize:12,color:'#9fead6',lineHeight:20},b:{fontSize:18,color:'#e8fdff',fontWeight:'bold'}}},
          labelLine:{show:false},
          data:[{value:normal,name:'æ­£å¸¸',itemStyle:{color:'#6be29a'}},{value:warn,name:'è­¦æˆ’',itemStyle:{color:'#ffd86b'}},{value:alarm,name:'è¶…è­¦',itemStyle:{color:'#ff6b6b'}}]
        }]
      };
      try{ levelPercentChart.setOption(option, true); }catch(e){ console.warn('updateLevelPercentChart å¤±è´¥', e); }
    }

    function simStart(){
      // å­˜å‚¨ä¸Šä¸€æ¬¡æ°´ä½ï¼Œç”¨äºè®¡ç®—æ¶¨å¹…
      const previousLevels = {};
      stations.forEach(s => previousLevels[s.name] = s.level);
      
      simTimer = setInterval(()=>{
        // éšæœºæ”¹å˜å„ç«™æ°´ä½å¹¶åˆ·æ–°
        stations.forEach(s=>{ 
          const oldLevel = s.level;
          s.level += (Math.random()-0.45)*0.05; 
          if(s.level<0) s.level=0;
          
          // æ£€æŸ¥é¢„è­¦
          const key = `alert_${s.name}`;
          const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
          
          if (settings.enabled) {
            let alertMessage = '';
            
            // æ£€æŸ¥æ°´ä½é˜ˆå€¼
            if (s.level > settings.threshold) {
              alertMessage += `âš ï¸ ${s.name} æ°´ä½è¶…é™ï¼å½“å‰ï¼š${s.level.toFixed(2)}mï¼Œé˜ˆå€¼ï¼š${settings.threshold}m`;
            }
            
            // æ£€æŸ¥æ¶¨å¹…é˜ˆå€¼ï¼ˆ2ç§’é—´éš”ï¼Œæ¢ç®—æˆå°æ—¶æ¶¨å¹…ï¼‰
            const prevLevel = previousLevels[s.name] || oldLevel;
            const riseRate = (s.level - prevLevel) * (3600 / 2); // è½¬æ¢ä¸ºç±³/å°æ—¶
            if (riseRate > settings.rateThreshold) {
              if (alertMessage) alertMessage += '\n';
              alertMessage += `âš ï¸ ${s.name} æ¶¨å¹…è¿‡å¿«ï¼å½“å‰æ¶¨å¹…ï¼š${riseRate.toFixed(3)}m/hï¼Œé˜ˆå€¼ï¼š${settings.rateThreshold}m/h`;
            }
            
            if (alertMessage) {
              console.warn(alertMessage);
              
              // è°ƒç”¨åç«¯æ£€æŸ¥APIï¼ˆç”¨äºè®°å½•å’Œåˆ†æï¼‰
              fetch('http://localhost:3001/api/alerts/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  station_name: s.name,
                  current_level: s.level,
                  rise_rate: riseRate
                })
              }).catch(err => console.warn('åç«¯æ£€æŸ¥å¤±è´¥:', err));
              
              // æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥
              if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸš¨ æ°´ä½é¢„è­¦', { 
                  body: alertMessage, 
                  icon: 'âš ï¸',
                  tag: `alert_${s.name}`,
                  requireInteraction: true
                });
              }
            }
          }
          
          previousLevels[s.name] = s.level;
        });
        
        renderStationTable(); updateMapData(); updateLevelChart();
        // åŒæ­¥å³ä¸Šè§’é€‰ä¸­ç«™ç‚¹æ°´ä½æ˜¾ç¤ºï¼ˆè‹¥æœ‰é€‰ä¸­ï¼‰
        try{ if(selectedStation) updateSelectedHeader(selectedStation); }catch(e){}
        try{ updateLevelPercentChart(); }catch(e){}
      },2000)
    }

    function updateMapData(){
      if(!mapChart) return;
      // åªä½¿ç”¨æ‹¥æœ‰æœ‰æ•ˆç»çº¬çš„ç«™ç‚¹ï¼Œé˜²æ­¢æ„å¤–çš„ null/undefined å¼•èµ·æ¸²æŸ“é”™è¯¯
      function validCoord(s){ return s && Array.isArray(s.coord) && s.coord.length>=2 && isFinite(s.coord[0]) && isFinite(s.coord[1]); }
      const scatter = stations.filter(validCoord).map(s=>({name:s.name,value:[s.coord[0],s.coord[1],Number((s.level||0).toFixed(2))]}));
      const alerts = stations.filter(s=> validCoord(s) && s.level>1.4 ).map(s=>({name:s.name,value:[s.coord[0],s.coord[1],Number((s.level||0).toFixed(2))]}));
      // ä»…æ›´æ–°å‰ä¸¤ä¸ª seriesï¼ˆscatter ä¸ effectScatterï¼‰ï¼Œä¿ç•™æ¼“æ±Ÿ lines series
      try{
        mapChart.setOption({series:[{data:scatter},{data:alerts}]});
      }catch(e){
        console.warn('updateMapData setOption å¤±è´¥', e);
        try{ mapChart.setOption({series:[{data:scatter||[]},{data:alerts||[]} ]}); }catch(e2){ /* ignore */ }
      }
    }

    init();
    // ç®€æŠ¥åŠ©æ‰‹ï¼šä¼˜å…ˆè°ƒç”¨åç«¯ dataagentï¼ˆLangChainï¼‰ï¼Œå¤±è´¥å›é€€æœ¬åœ°å…³é”®è¯
    const briefingTextEl = document.getElementById('briefingText');
    const briefingReply = document.getElementById('briefingReply');

    function getBriefingReplyLocal(q) {
      q = (q || '').trim();
      if (!q) return 'è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚';
      if (/é›¨é‡|é™é›¨|æš´é›¨/.test(q)) return 'è¿‡å»24å°æ—¶æ¡‚æ—å¸‚æ™®é™å¤§åˆ°æš´é›¨ï¼Œéƒ¨åˆ†å¿åŒºå±€éƒ¨é™å¤§æš´é›¨ï¼Œæœ€å¤§æ—¥é›¨é‡165.5æ¯«ç±³ã€‚';
      if (/æ°´ä½|æµé‡|æ¡‚æ—æ°´æ–‡ç«™/.test(q)) return 'æ¼“æ±Ÿæ¡‚æ—æ°´æ–‡ç«™æ°´ä½142.20ç±³ï¼Œæµé‡154ç«‹æ–¹ç±³æ¯ç§’ï¼Œæœªè¶…è­¦ã€‚';
      if (/æœªæ¥|é¢„æŠ¥|è¶‹åŠ¿/.test(q)) return 'é¢„è®¡æœªæ¥24å°æ—¶æ¼“æ±Ÿæ¡‚æ—å¸‚åŸåŒºè‡³é˜³æœ”å¿åŸæ²³æ®µæ°´ä½å°†ç»§ç»­ä¸Šæ¶¨1.5ï½2ç±³ï¼Œæ¡‚æ±Ÿå¹³ä¹å¿åŸæ²³æ®µä¸Šæ¶¨çº¦1ç±³ï¼Œä¸ä¼šè¶…è­¦ã€‚';
      if (/è¶…è­¦|æ´ªæ°´|é£é™©/.test(q)) return 'éƒ¨åˆ†ä¸­å°æ²³æµå¯èƒ½å‡ºç°è¶…è­¦æ´ªæ°´ï¼Œä¸»è¦é›†ä¸­åœ¨å…¨å·ã€æ­åŸã€æ°¸ç¦ã€ä¸´æ¡‚ã€é˜³æœ”ç­‰å¿åŒºã€‚';
      if (/å“ªäº›æ²³æµ|æ¶¨æ°´|å—å½±å“/.test(q)) return 'æ­åŸæ²³ã€æ¹˜æ±Ÿå…¨å·å¿åŸæ²³æ®µã€æ°¸ç¦å¿å¤§é‚¦æ²³ã€çŒé˜³å¿ç§€æ±Ÿã€é›å±±åŒºè‰¯ä¸°æ²³ç­‰å¤šæ¡æ²³æµå‡ºç°äº†1ï½2.6ç±³çš„æ¶¨æ°´ã€‚';
      if (/å…¨éƒ¨ç®€æŠ¥|è¯¦ç»†/.test(q)) return briefingTextEl ? briefingTextEl.innerText : '';
      return 'å¾ˆæŠ±æ­‰ï¼Œæœªèƒ½ç†è§£æ‚¨çš„é—®é¢˜ã€‚è¯·å°è¯•è¾“å…¥â€œé›¨é‡â€ã€â€œæ°´ä½â€ã€â€œæœªæ¥è¶‹åŠ¿â€ã€â€œè¶…è­¦â€ç­‰å…³é”®è¯ã€‚';
    }

    async function callBackendBriefing(q){
      const url = 'http://localhost:3001/api/briefing';
      // ä» localStorage è·å–ä¿å­˜çš„ API Key å’Œæ¨¡å‹
      const config = getApiConfig ? getApiConfig() : {};
      const requestBody = {
        q: q,
        api_key: config.apiKey || undefined,
        model: config.model || undefined
      };
      const resp = await fetch(url, {
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(requestBody)
      });
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const data = await resp.json();
      // backend returns {reply: '...', source: '...'}
      return data && (data.reply || data.reply === '') ? data.reply : JSON.stringify(data);
    }

    document.getElementById('briefingAskBtn').onclick = async function() {
      const q = document.getElementById('briefingInput').value || '';
      briefingReply.innerText = 'åŠ è½½ä¸­...';
      try{
        const r = await callBackendBriefing(q);
        briefingReply.innerText = r;
      }catch(e){
        // fallback to local logic
        briefingReply.innerText = getBriefingReplyLocal(q);
      }
    };

    document.getElementById('briefingInput').addEventListener('keydown', function(e){
      if(e.key==='Enter'){
        document.getElementById('briefingAskBtn').click();
      }
    });

    // ç”Ÿæˆç®€æŠ¥ï¼šè°ƒç”¨åç«¯æ™ºèƒ½ä½“ç”Ÿæˆå¹¶æ›´æ–°å³ä¾§ç®€æŠ¥æ–‡æœ¬
    const genBtn = document.getElementById('briefingGenerateBtn');
    if(genBtn){
      genBtn.onclick = async function(){
        genBtn.disabled = true; genBtn.textContent = 'ç”Ÿæˆä¸­...';
        try{
          // è°ƒç”¨ä¸“é—¨çš„ç®€æŠ¥ç”Ÿæˆæ¥å£
          const url = 'http://localhost:3001/api/briefing/generate';
          
          // ä» localStorage è·å–ä¿å­˜çš„ API Key å’Œæ¨¡å‹
          const config = getApiConfig ? getApiConfig() : {};
          
          const requestBody = {
            api_key: config.apiKey || undefined,
            model: config.model || undefined
          };
          
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const data = await resp.json();
          
          // è·å– Markdown å†…å®¹
          const markdownContent = data.reply || 'ç”Ÿæˆå¤±è´¥';
          
          // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ•°æ®æº
          console.log(`[ç®€æŠ¥] æ•°æ®æº: ${data.source}`);
          
          // æ›´æ–°ç®€æŠ¥æ˜¾ç¤ºåŒºåŸŸ
          if(briefingTextEl) {
            briefingTextEl.innerHTML = marked.parse(markdownContent);
            briefingTextEl.classList.add('markdown-content');
          }
        }catch(e){
          if(briefingTextEl) {
            briefingTextEl.innerText = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯: ' + e.message;
            briefingTextEl.classList.remove('markdown-content');
          }
        }finally{
          genBtn.disabled = false; genBtn.textContent = 'ç”Ÿæˆç®€æŠ¥';
        }
      };
    }
  </script>

  <!-- ç®€æŠ¥/å‘¨æŠ¥æ”¾å¤§æ¨¡æ€çª—å£ -->
  <div id="briefingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ç®€æŠ¥è¯¦æƒ…</h2>
        <button class="modal-close-btn" onclick="closeBriefingModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBriefingContent"></div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="copyModalContent()">å¤åˆ¶å†…å®¹</button>
        <button class="modal-btn modal-btn-primary" onclick="closeBriefingModal()">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    // æ”¾å¤§ç®€æŠ¥çš„å‡½æ•°
    function openBriefingModal() {
      const briefingTextEl = document.getElementById('briefingText');
      const modalContent = document.getElementById('modalBriefingContent');
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ Markdown å†…å®¹ï¼ˆæœ‰ HTML æ ‡ç­¾ï¼‰
      if (briefingTextEl.innerHTML && briefingTextEl.innerHTML.includes('<')) {
        // å¤åˆ¶ HTML å†…å®¹
        modalContent.innerHTML = briefingTextEl.innerHTML;
        modalContent.classList.add('markdown-content');
      } else {
        // å¤åˆ¶çº¯æ–‡æœ¬
        modalContent.innerText = briefingTextEl.innerText;
        modalContent.classList.remove('markdown-content');
      }
      document.getElementById('briefingModal').classList.add('show');
    }

    // å…³é—­æ¨¡æ€çª—å£
    function closeBriefingModal() {
      document.getElementById('briefingModal').classList.remove('show');
    }

    // å¤åˆ¶æ¨¡æ€çª—å£ä¸­çš„å†…å®¹
    function copyModalContent() {
      const modalContent = document.getElementById('modalBriefingContent').innerText;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(modalContent).then(() => {
          alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          fallbackCopy(modalContent);
        });
      } else {
        fallbackCopy(modalContent);
      }
    }

    // å¤åˆ¶ç®€æŠ¥æ–‡æœ¬ï¼ˆç›´æ¥å¤åˆ¶ï¼‰
    function copyBriefingText() {
      const briefingText = document.getElementById('briefingText').innerText;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(briefingText).then(() => {
          alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          fallbackCopy(briefingText);
        });
      } else {
        fallbackCopy(briefingText);
      }
    }

    // å¤‡ç”¨å¤åˆ¶æ–¹æ³•ï¼ˆé’ˆå¯¹ä¸æ”¯æŒ Clipboard API çš„æµè§ˆå™¨ï¼‰
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      }
      document.body.removeChild(textArea);
    }

    // å…³é—­æ¨¡æ€çª—å£æ—¶ç‚¹å‡»èƒŒæ™¯
    document.getElementById('briefingModal').addEventListener('click', function(event) {
      if (event.target === this) {
        closeBriefingModal();
      }
    });

    // ç»‘å®šæ”¾å¤§å’Œå¤åˆ¶æŒ‰é’®
    document.getElementById('briefingEnlargeBtn').addEventListener('click', openBriefingModal);
    document.getElementById('briefingCopyBtn').addEventListener('click', copyBriefingText);
    // é¢„è­¦ç®¡ç†
    function openAlertManagement() {
      document.getElementById('alertManagementModal').style.display = 'block';
      renderAlertManagementTable();
    }

    function closeAlertManagement() {
      document.getElementById('alertManagementModal').style.display = 'none';
    }

    // æ‰“å¼€è¶‹åŠ¿å¼¹çª—çš„å¿«æ·å‡½æ•°
    function openTrendPopup(stationName) {
      try {
        console.log('ğŸ” openTrendPopup è¢«è°ƒç”¨ï¼Œç«™ç‚¹å:', stationName);
        
        if (!stationName || typeof stationName !== 'string') {
          console.error('âŒ æ— æ•ˆçš„ç«™ç‚¹åç§°:', stationName);
          alert('âŒ ç«™ç‚¹åç§°æ— æ•ˆ');
          return;
        }
        
        if (!stations || !Array.isArray(stations)) {
          console.error('âŒ stations æœªå®šä¹‰æˆ–ä¸æ˜¯æ•°ç»„');
          alert('âŒ ç³»ç»Ÿé”™è¯¯ï¼šç«™ç‚¹åˆ—è¡¨æœªåŠ è½½');
          return;
        }
        
        console.log('ğŸ” åœ¨', stations.length, 'ä¸ªç«™ç‚¹ä¸­æŸ¥æ‰¾:', stationName);
        const station = stations.find(s => s && s.name === stationName);
        
        if (!station) {
          console.warn('âŒ æ‰¾ä¸åˆ°ç«™ç‚¹:', stationName);
          console.log('å¯ç”¨ç«™ç‚¹:', stations.map(s => s?.name).filter(Boolean));
          alert('âŒ ç«™ç‚¹æœªæ‰¾åˆ°: ' + stationName);
          return;
        }
        
        console.log('âœ… æ‰¾åˆ°ç«™ç‚¹:', station.name, 'æ°´ä½:', station.level, 'åæ ‡:', station.coord);
        
        if (!station.name || typeof station.level !== 'number' || !station.coord || !station.addr || !station.type) {
          console.error('âŒ ç«™ç‚¹æ•°æ®ä¸å®Œæ•´:', station);
          alert('âŒ ç«™ç‚¹æ•°æ®ä¸å®Œæ•´');
          return;
        }
        
        console.log('ğŸ“Š è°ƒç”¨ showPopup æ‰“å¼€å¼¹çª—');
        showPopup(station);
      } catch(err) {
        console.error('âŒ æ‰“å¼€è¶‹åŠ¿å¼¹çª—å¼‚å¸¸:', err, 'å †æ ˆ:', err.stack);
        alert('âŒ æ‰“å¼€å¤±è´¥: ' + err.message);
      }
    }

    function renderAlertManagementTable() {
      const tbody = document.getElementById('alertTableBody');
      tbody.innerHTML = '';
      
      // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
      let enabledCount = 0;
      stations.forEach(station => {
        const key = `alert_${station.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
        if (settings.enabled) enabledCount++;
      });
      
      stations.forEach((station, index) => {
        const key = `alert_${station.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
        
        const tr = document.createElement('tr');
        tr.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';
        tr.style.borderBottom = '1px solid #e0e0e0';
        tr.style.transition = 'background-color 0.3s';
        tr.onmouseover = () => tr.style.backgroundColor = '#e8f4ff';
        tr.onmouseout = () => tr.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';
        
        const statusBadge = settings.enabled ? 
          '<span style="display:inline-block;padding:2px 8px;background:#ff6b6b;color:#fff;border-radius:4px;font-size:12px;font-weight:bold">å·²å¯ç”¨</span>' :
          '<span style="display:inline-block;padding:2px 8px;background:#d9d9d9;color:#666;border-radius:4px;font-size:12px">æœªå¯ç”¨</span>';
        
        tr.innerHTML = `
          <td style="padding:12px;color:#333">${station.name}</td>
          <td style="padding:12px;color:#666;font-size:13px">${station.type}</td>
          <td style="padding:12px;color:#999;font-size:12px">${station.addr}</td>
          <td style="padding:12px;text-align:center">
            <input type="checkbox" id="enable_${station.id}" ${settings.enabled ? 'checked' : ''} 
              onchange="updateAlertEnabled(${station.id}, '${station.name}', this.checked)"
              style="width:16px;height:16px;cursor:pointer">
          </td>
          <td style="padding:12px;text-align:center">
            <input type="number" id="threshold_${station.id}" value="${settings.threshold}" 
              step="0.1" min="0" max="5"
              style="width:70px;padding:6px;border:1px solid #ddd;border-radius:4px;text-align:center;font-size:13px"
              onchange="updateAlertThreshold(${station.id}, '${station.name}', 'threshold', this.value)"
              onkeyup="updateAlertThreshold(${station.id}, '${station.name}', 'threshold', this.value)">
          </td>
          <td style="padding:12px;text-align:center">
            <input type="number" id="rate_${station.id}" value="${settings.rateThreshold}" 
              step="0.01" min="0" max="1"
              style="width:70px;padding:6px;border:1px solid #ddd;border-radius:4px;text-align:center;font-size:13px"
              onchange="updateAlertThreshold(${station.id}, '${station.name}', 'rateThreshold', this.value)"
              onkeyup="updateAlertThreshold(${station.id}, '${station.name}', 'rateThreshold', this.value)">
          </td>
          <td style="padding:12px;text-align:center">
            <button style="padding:6px 14px;background:linear-gradient(135deg,#4a9eff,#357abd);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;transition:all 0.3s;z-index:10;position:relative"
              onmouseover="this.style.boxShadow='0 4px 12px rgba(74,158,255,0.4)';this.style.transform='scale(1.05)'"
              onmouseout="this.style.boxShadow='none';this.style.transform='scale(1)'"
              onclick="openTrendPopup('${station.name}')">
              ğŸ“Š æŸ¥çœ‹è¶‹åŠ¿
            </button>
          </td>
          <td style="padding:12px;text-align:center">
            <button style="padding:6px 14px;background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;transition:all 0.3s"
              onmouseover="this.style.boxShadow='0 4px 12px rgba(46,204,113,0.4)';this.style.transform='scale(1.05)'"
              onmouseout="this.style.boxShadow='none';this.style.transform='scale(1)'"
              onclick="confirmAlertSettings(${station.id}, '${station.name}')">
              âœ… ç¡®å®š
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      const statsElement = document.getElementById('alertStatsDisplay');
      if (statsElement) {
        statsElement.innerText = `å·²é…ç½®é¢„è­¦ï¼š${enabledCount}/${stations.length} ä¸ªç«™ç‚¹`;
      }
      
      console.log('è¡¨æ ¼å·²æ¸²æŸ“ï¼Œå·²å¯ç”¨é¢„è­¦:', enabledCount, 'å…±:', stations.length);
    }

    function updateAlertEnabled(id, name, enabled) {
      const key = `alert_${name}`;
      const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1}');
      settings.enabled = enabled;
      localStorage.setItem(key, JSON.stringify(settings));
      renderAlertManagementTable();
    }

    function updateAlertThreshold(id, name, field, value) {
      const key = `alert_${name}`;
      const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
      settings[field] = parseFloat(value);
      localStorage.setItem(key, JSON.stringify(settings));
    }

    // ç¡®å®šæŒ‰é’®å¤„ç†å‡½æ•° - ç¡®è®¤è¯¥ç«™ç‚¹çš„é¢„è­¦è®¾ç½®
    function confirmAlertSettings(id, stationName) {
      try {
        const key = `alert_${stationName}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
        
        // è·å–è¯¥è¡Œçš„è¾“å…¥å€¼
        const threshold = parseFloat(document.getElementById(`threshold_${id}`).value);
        const rateThreshold = parseFloat(document.getElementById(`rate_${id}`).value);
        const isEnabled = document.getElementById(`enable_${id}`).checked;
        
        // éªŒè¯æ•°å€¼
        if (isNaN(threshold) || isNaN(rateThreshold)) {
          alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
          return;
        }
        
        if (threshold < 0 || threshold > 5) {
          alert('âŒ æ°´ä½é˜ˆå€¼èŒƒå›´åº”åœ¨ 0-5 m ä¹‹é—´');
          return;
        }
        
        if (rateThreshold < 0 || rateThreshold > 1) {
          alert('âŒ æ¶¨å¹…é˜ˆå€¼èŒƒå›´åº”åœ¨ 0-1 m/h ä¹‹é—´');
          return;
        }
        
        // ä¿å­˜è®¾ç½®
        settings.threshold = threshold;
        settings.rateThreshold = rateThreshold;
        settings.enabled = isEnabled;
        localStorage.setItem(key, JSON.stringify(settings));
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        console.log('âœ… å·²ä¿å­˜ ' + stationName + ' çš„é¢„è­¦è®¾ç½®');
        alert(`âœ… å·²ä¿å­˜ ${stationName} çš„é¢„è­¦è®¾ç½®\næ°´ä½é˜ˆå€¼ï¼š${threshold}m\næ¶¨å¹…é˜ˆå€¼ï¼š${rateThreshold}m/h\né¢„è­¦çŠ¶æ€ï¼š${isEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        
        // ğŸ”„ ç«‹å³åˆ·æ–°ç›¸å…³ UIï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢
        console.log('ğŸ”„ æ­£åœ¨åˆ·æ–° UI...');
        renderAlertManagementTable();  // åˆ·æ–°é¢„è­¦ç®¡ç†è¡¨æ ¼
        renderStationTable();           // åˆ·æ–°å·¦ä¾§ç«™ç‚¹åˆ—è¡¨å’Œå¾½ç« 
        updateLevelChart();             // æ›´æ–°æ°´ä½å›¾è¡¨
      } catch(err) {
        console.error('âŒ ä¿å­˜è®¾ç½®å¤±è´¥:', err);
        alert('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    function batchEnableAlerts(enable) {
      try {
        stations.forEach(station => {
          const key = `alert_${station.name}`;
          const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
          settings.enabled = enable;
          localStorage.setItem(key, JSON.stringify(settings));
        });
        renderAlertManagementTable();
        renderStationTable();  // åŒæ—¶æ›´æ–°ä¸»è¡¨æ ¼çš„å¾½ç« æ˜¾ç¤º
        alert(enable ? 'âœ… å·²å¯ç”¨æ‰€æœ‰ç«™ç‚¹é¢„è­¦\nå…± ' + stations.length + ' ä¸ªç«™ç‚¹' : 'â›” å·²ç¦ç”¨æ‰€æœ‰ç«™ç‚¹é¢„è­¦');
      } catch(err) {
        console.error('æ‰¹é‡æ“ä½œå¤±è´¥:', err);
        alert('âŒ æ“ä½œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°');
      }
    }

    function setDefaultThresholds() {
      const defaultThreshold = prompt('è¯·è¾“å…¥é»˜è®¤æ°´ä½é˜ˆå€¼(m):', '1.4');
      if (defaultThreshold === null) return;
      
      const defaultRate = prompt('è¯·è¾“å…¥é»˜è®¤æ¶¨å¹…é˜ˆå€¼(m/h):', '0.1');
      if (defaultRate === null) return;
      
      const threshold = parseFloat(defaultThreshold);
      const rateThreshold = parseFloat(defaultRate);
      
      if (isNaN(threshold) || isNaN(rateThreshold)) {
        alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
        return;
      }
      
      if (threshold <= 0 || rateThreshold < 0) {
        alert('âŒ é˜ˆå€¼å¿…é¡»å¤§äº0');
        return;
      }
      
      // è°ƒç”¨åç«¯API
      fetch('http://localhost:3001/api/alerts/set-default', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ threshold, rate_threshold: rateThreshold })
      })
      .then(r => r.json())
      .then(data => {
        console.log('åç«¯å·²è®°å½•é»˜è®¤é˜ˆå€¼');
      })
      .catch(err => console.warn('åç«¯è®¾ç½®å¤±è´¥:', err));
      
      // åº”ç”¨åˆ°æ‰€æœ‰æœ¬åœ°ç«™ç‚¹
      stations.forEach(station => {
        const key = `alert_${station.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"enabled":false}');
        settings.threshold = threshold;
        settings.rateThreshold = rateThreshold;
        localStorage.setItem(key, JSON.stringify(settings));
      });
      
      renderAlertManagementTable();
      alert(`âœ… å·²è®¾ç½®æ‰€æœ‰ç«™ç‚¹é»˜è®¤é˜ˆå€¼ï¼šæ°´ä½=${threshold}m, æ¶¨å¹…=${rateThreshold}m/h`);
    }

    function exportAlertSettings() {
      const exportData = {};
      stations.forEach(station => {
        const key = `alert_${station.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
        exportData[station.name] = settings;
      });
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `alert_settings_${new Date().toISOString().slice(0, 10)}.json`;
      link.click();
      URL.revokeObjectURL(url);
      alert('âœ… é¢„è­¦è®¾ç½®å·²å¯¼å‡º');
    }

    function filterAlertTable() {
      const searchText = document.getElementById('alertSearchInput').value.toLowerCase();
      const typeFilter = document.getElementById('alertTypeFilter').value;
      
      const rows = document.querySelectorAll('#alertTableBody tr');
      rows.forEach(row => {
        const name = row.cells[0]?.textContent.toLowerCase() || '';
        const addr = row.cells[2]?.textContent.toLowerCase() || '';
        const type = row.cells[1]?.textContent || '';
        
        const matchesSearch = name.includes(searchText) || addr.includes(searchText);
        const matchesType = typeFilter === '' || type === typeFilter;
        
        row.style.display = matchesSearch && matchesType ? '' : 'none';
      });
    }

    function saveAllAlerts() {
      // æ”¶é›†æ‰€æœ‰é¢„è­¦è®¾ç½®
      const allSettings = {};
      stations.forEach(station => {
        const key = `alert_${station.name}`;
        const settings = JSON.parse(localStorage.getItem(key) || '{"threshold":1.4,"rateThreshold":0.1,"enabled":false}');
        allSettings[station.name] = settings;
      });
      
      // å°è¯•å‘é€åˆ°åç«¯
      fetch('http://localhost:3001/api/alerts/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ settings: allSettings })
      })
      .then(r => r.json())
      .then(data => {
        alert(`âœ… ${data.message}`);
        closeAlertManagement();
      })
      .catch(err => {
        console.warn('åç«¯ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', err);
        alert('âœ… æ‰€æœ‰é¢„è­¦è®¾ç½®å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼');
        closeAlertManagement();
      });
    }

    function clearAllAlerts() {
      if (confirm('âš ï¸ ç¡®è®¤æ¸…é™¤æ‰€æœ‰ç«™ç‚¹çš„é¢„è­¦è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        stations.forEach(station => {
          localStorage.removeItem(`alert_${station.name}`);
        });
        renderAlertManagementTable();
        renderStationTable();  // åŒæ­¥æ›´æ–°å·¦ä¾§æ ï¼Œç§»é™¤å¾½ç« 
        alert('âœ… å·²æ¸…é™¤æ‰€æœ‰é¢„è­¦è®¾ç½®ï¼');
        console.log('âœ… å·²æ¸…é™¤æ‰€æœ‰é¢„è­¦è®¾ç½®å¹¶æ›´æ–°UI');
      }
    }

    // ========== AI é…ç½®ç›¸å…³å‡½æ•° ==========

    // æ‰“å¼€ API é…ç½®é¢æ¿
    function openApiConfig() {
      console.log('ğŸ“¡ æ‰“å¼€ API é…ç½®é¢æ¿');
      const modal = document.getElementById('apiConfigModal');
      const panel = document.getElementById('apiConfigPanel');
      
      // åŠ è½½ä¿å­˜çš„é…ç½®
      loadApiConfig();
      
      if (modal && panel) {
        modal.style.display = 'flex';
        panel.style.display = 'block';
        
        // ç‚¹å‡»é®ç½©å…³é—­
        modal.onclick = function(e) {
          if (e.target === modal) {
            closeApiConfig();
          }
        };
      }
    }

    // å…³é—­ API é…ç½®é¢æ¿
    function closeApiConfig() {
      console.log('ğŸ“¡ å…³é—­ API é…ç½®é¢æ¿');
      const modal = document.getElementById('apiConfigModal');
      const panel = document.getElementById('apiConfigPanel');
      
      if (modal && panel) {
        modal.style.display = 'none';
        panel.style.display = 'none';
      }
    }

    // åŠ è½½ä¿å­˜çš„ API é…ç½®
    function loadApiConfig() {
      const config = JSON.parse(localStorage.getItem('apiConfig') || '{"model":"qwen-plus","apiKey":""}');
      
      const modelSelect = document.getElementById('qwenModelSelect');
      const apiKeyInput = document.getElementById('dashscopeApiKey');
      
      if (modelSelect) {
        modelSelect.value = config.model || 'qwen-plus';
      }
      
      if (apiKeyInput) {
        apiKeyInput.value = config.apiKey || '';
        apiKeyInput.type = 'password'; // é»˜è®¤éšè—
      }
      
      console.log('âœ… å·²åŠ è½½ API é…ç½®:', { model: config.model });
    }

    // åˆ‡æ¢ API Key æ˜¾ç¤º/éšè—
    function toggleApiKeyVisibility() {
      const input = document.getElementById('dashscopeApiKey');
      const btn = document.getElementById('toggleApiKeyBtn');
      
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'ğŸ™ˆ éšè—';
      } else {
        input.type = 'password';
        btn.textContent = 'ğŸ‘ï¸ æ˜¾ç¤º';
      }
    }

    // ä¿å­˜ API é…ç½®
    function saveApiConfig() {
      const modelSelect = document.getElementById('qwenModelSelect');
      const apiKeyInput = document.getElementById('dashscopeApiKey');
      const testResultDiv = document.getElementById('testResult');
      const saveBtn = document.getElementById('saveApiConfigBtn');
      
      const model = modelSelect.value;
      const apiKey = apiKeyInput.value.trim();
      
      // éªŒè¯ API Key
      if (!apiKey) {
        alert('âš ï¸ è¯·è¾“å…¥ API Key');
        return;
      }
      
      if (!apiKey.startsWith('sk-')) {
        alert('âš ï¸ API Key æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ sk- å¼€å¤´');
        return;
      }
      
      // ä¿å­˜é…ç½®åˆ° localStorage
      const config = { model, apiKey };
      localStorage.setItem('apiConfig', JSON.stringify(config));
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      saveBtn.style.opacity = '0.6';
      saveBtn.textContent = 'âœ… å·²ä¿å­˜';
      
      setTimeout(() => {
        saveBtn.style.opacity = '1';
        saveBtn.textContent = 'âœ… ä¿å­˜é…ç½®';
      }, 2000);
      
      console.log('ğŸ’¾ API é…ç½®å·²ä¿å­˜:', { model });
      alert('âœ… é…ç½®å·²æˆåŠŸä¿å­˜ï¼');
    }

    // æ¸…é™¤ API é…ç½®
    function clearApiConfig() {
      if (confirm('âš ï¸ ç¡®è®¤æ¸…é™¤æ‰€æœ‰ API é…ç½®å—ï¼Ÿ')) {
        localStorage.removeItem('apiConfig');
        
        const modelSelect = document.getElementById('qwenModelSelect');
        const apiKeyInput = document.getElementById('dashscopeApiKey');
        
        if (modelSelect) modelSelect.value = 'qwen-plus';
        if (apiKeyInput) apiKeyInput.value = '';
        
        alert('âœ… é…ç½®å·²æ¸…é™¤');
        console.log('ğŸ—‘ï¸ API é…ç½®å·²æ¸…é™¤');
      }
    }

    // æµ‹è¯• Qwen è¿æ¥
    function testQwenConnection() {
      const apiKeyInput = document.getElementById('dashscopeApiKey');
      const modelSelect = document.getElementById('qwenModelSelect');
      const testPrompt = document.getElementById('testPrompt');
      const testResultDiv = document.getElementById('testResult');
      const testBtn = document.getElementById('testApiBtn');
      
      const apiKey = apiKeyInput.value.trim();
      const model = modelSelect.value;
      const prompt = testPrompt.value.trim();
      
      // éªŒè¯
      if (!apiKey) {
        alert('âš ï¸ è¯·å…ˆè¾“å…¥ API Key');
        return;
      }
      
      if (!prompt) {
        alert('âš ï¸ è¯·è¾“å…¥æµ‹è¯•é—®é¢˜');
        return;
      }
      
      // æ›´æ–° UI
      testResultDiv.style.display = 'block';
      testResultDiv.innerHTML = 'â³ æ­£åœ¨æµ‹è¯•è¿æ¥...';
      testBtn.disabled = true;
      testBtn.style.opacity = '0.6';
      
      console.log(`ğŸ§ª æµ‹è¯• Qwen è¿æ¥ - æ¨¡å‹: ${model}, é—®é¢˜: ${prompt}`);
      
      // è°ƒç”¨ FastAPI åç«¯ï¼Œä¼ é€’ API Key å’Œæ¨¡å‹
      fetch('http://localhost:3001/api/briefing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          q: prompt,
          api_key: apiKey,
          model: model
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… è¿æ¥æˆåŠŸï¼Œå›å¤:', data);
        testResultDiv.innerHTML = `
          <div style="color:#2ecc71;font-weight:bold;margin-bottom:6px">âœ… è¿æ¥æˆåŠŸï¼</div>
          <div style="color:#bfefff">${data.reply || data.error || 'æ”¶åˆ°å›å¤'}</div>
        `;
      })
      .catch(error => {
        console.error('âŒ è¿æ¥å¤±è´¥:', error);
        testResultDiv.innerHTML = `
          <div style="color:#e86464;font-weight:bold;margin-bottom:6px">âŒ è¿æ¥å¤±è´¥</div>
          <div style="color:#ffb3b3">${error.message}</div>
          <div style="color:#999;font-size:10px;margin-top:8px">å¸¸è§åŸå› ï¼š
            <ul style="margin:6px 0;padding-left:12px">
              <li>API Key æ— æ•ˆæˆ–è¿‡æœŸ</li>
              <li>åç«¯æœåŠ¡æœªå¯åŠ¨ (localhost:3000)</li>
              <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
              <li>æ¨¡å‹åç§°ä¸æ­£ç¡®</li>
            </ul>
          </div>
        `;
      })
      .finally(() => {
        testBtn.disabled = false;
        testBtn.style.opacity = '1';
      });
    }

    // è·å–ä¿å­˜çš„ API é…ç½®
    function getApiConfig() {
      return JSON.parse(localStorage.getItem('apiConfig') || '{"model":"qwen-plus","apiKey":""}');
    }

  </script>

  <!-- é¢„è­¦ç®¡ç†æ¨¡æ€çª—å£ -->
  <div id="alertManagementModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:1400px;max-height:95vh;overflow:auto;background:#f5f7fa">
      <!-- æ ‡é¢˜æ  -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;background:linear-gradient(135deg,#0b5260,#1a7a8f);color:#fff;padding:20px;border-radius:8px 8px 0 0;margin:-16px -16px 20px -16px">
        <div>
          <h2 style="margin:0;font-size:28px;font-weight:bold">
            âš ï¸ é¢„è­¦ç®¡ç†ä¸­å¿ƒ
          </h2>
          <p style="margin:8px 0 0 0;font-size:13px;opacity:0.9">
            å®æ—¶ç›‘æµ‹å’Œç®¡ç†æ‰€æœ‰æ°´æ–‡ç«™ç‚¹çš„æ°´ä½é¢„è­¦
          </p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="text-align:right">
            <div id="alertStatsDisplay" style="font-size:16px;font-weight:bold">å·²é…ç½®é¢„è­¦ï¼š0/33 ä¸ªç«™ç‚¹</div>
            <div style="font-size:12px;opacity:0.8;margin-top:4px">æ‰€æœ‰è®¾ç½®è‡ªåŠ¨ä¿å­˜</div>
          </div>
          <button onclick="closeAlertManagement()" style="background:none;border:none;font-size:32px;cursor:pointer;color:#fff;opacity:0.8">&times;</button>
        </div>
      </div>

      <!-- ä½¿ç”¨è¯´æ˜å¡ç‰‡ -->
      <div style="background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:16px;border-radius:8px;margin-bottom:20px;border-left:5px solid #4a9eff">
        <h3 style="margin:0 0 12px 0;color:#1a237e;font-size:16px;font-weight:bold">ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;color:#424242;line-height:1.6;font-size:13px">
          <div><span style="color:#1565c0;font-weight:bold">âœ“ å¯ç”¨é¢„è­¦ï¼š</span>å‹¾é€‰å¤é€‰æ¡†å¯ç”¨è¯¥ç«™ç‚¹çš„å®æ—¶ç›‘æµ‹</div>
          <div><span style="color:#1565c0;font-weight:bold">âœ“ æ°´ä½é˜ˆå€¼ï¼š</span>è¶…è¿‡æ­¤å€¼æ—¶è§¦å‘é¢„è­¦ï¼ˆå•ä½ï¼šç±³ï¼‰</div>
          <div><span style="color:#1565c0;font-weight:bold">âœ“ æ¶¨å¹…é˜ˆå€¼ï¼š</span>æ¯å°æ—¶æ¶¨å¹…è¶…è¿‡æ­¤å€¼æ—¶è§¦å‘é¢„è­¦ï¼ˆå•ä½ï¼šç±³/å°æ—¶ï¼‰</div>
          <div><span style="color:#1565c0;font-weight:bold">âœ“ æŸ¥çœ‹è¶‹åŠ¿ï¼š</span>ç‚¹å‡»æŸ¥çœ‹å†å²æ•°æ®å’Œé¢„æµ‹æ›²çº¿</div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’®ç»„ -->
      <div style="margin-bottom:16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <button onclick="batchEnableAlerts(true)" 
          style="padding:10px 18px;background:linear-gradient(135deg,#73d13d,#52c41a);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(82,196,26,0.4);transition:all 0.3s"
          onmouseover="this.style.boxShadow='0 4px 16px rgba(82,196,26,0.6)'"
          onmouseout="this.style.boxShadow='0 2px 8px rgba(82,196,26,0.4)'">
          âœ… å…¨éƒ¨å¯ç”¨
        </button>
        <button onclick="batchEnableAlerts(false)" 
          style="padding:10px 18px;background:linear-gradient(135deg,#d9d9d9,#b3b3b3);color:#333;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all 0.3s"
          onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.2)'"
          onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
          â›” å…¨éƒ¨ç¦ç”¨
        </button>
        <button onclick="setDefaultThresholds()" 
          style="padding:10px 18px;background:linear-gradient(135deg,#4a9eff,#357abd);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(74,158,255,0.4);transition:all 0.3s"
          onmouseover="this.style.boxShadow='0 4px 16px rgba(74,158,255,0.6)'"
          onmouseout="this.style.boxShadow='0 2px 8px rgba(74,158,255,0.4)'">
          ï¿½ è®¾ç½®é»˜è®¤é˜ˆå€¼
        </button>
        <button onclick="exportAlertSettings()" 
          style="padding:10px 18px;background:linear-gradient(135deg,#1890ff,#096dd9);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(24,144,255,0.4);transition:all 0.3s"
          onmouseover="this.style.boxShadow='0 4px 16px rgba(24,144,255,0.6)'"
          onmouseout="this.style.boxShadow='0 2px 8px rgba(24,144,255,0.4)'">
          ï¿½ å¯¼å‡ºé…ç½®
        </button>
        <button onclick="clearAllAlerts()" 
          style="padding:10px 18px;background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;box-shadow:0 2px 8px rgba(255,107,107,0.4);transition:all 0.3s"
          onmouseover="this.style.boxShadow='0 4px 16px rgba(255,107,107,0.6)'"
          onmouseout="this.style.boxShadow='0 2px 8px rgba(255,107,107,0.4)'">
          ï¿½ï¸ æ¸…é™¤æ‰€æœ‰
        </button>
      </div>

      <!-- æœç´¢å’Œç­›é€‰ -->
      <div style="margin-bottom:16px;display:flex;gap:12px">
        <input type="text" id="alertSearchInput" placeholder="ğŸ” æœç´¢ç«™ç‚¹åç§°ã€åœ°å€..." 
          style="flex:1;padding:10px 14px;border:1px solid #d9d9d9;border-radius:6px;font-size:13px;background:#fff"
          oninput="filterAlertTable()">
        <select id="alertTypeFilter" style="padding:10px 14px;border:1px solid #d9d9d9;border-radius:6px;font-size:13px;background:#fff;cursor:pointer" onchange="filterAlertTable()">
          <option value="">æ‰€æœ‰ç±»å‹</option>
          <option value="é›¨é‡ç«™">é›¨é‡ç«™</option>
          <option value="æ°´ä½ç«™">æ°´ä½ç«™</option>
          <option value="æ°”è±¡ç«™">æ°”è±¡ç«™</option>
        </select>
      </div>

      <!-- æ•°æ®è¡¨æ ¼ -->
      <div style="background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead>
              <tr style="background:linear-gradient(135deg,#4a9eff,#357abd);color:#fff">
                <th style="padding:14px 12px;text-align:left;font-weight:bold;min-width:100px">ç«™ç‚¹åç§°</th>
                <th style="padding:14px 12px;text-align:left;font-weight:bold;min-width:80px">ç±»å‹</th>
                <th style="padding:14px 12px;text-align:left;font-weight:bold;min-width:220px">åœ°å€</th>
                <th style="padding:14px 12px;text-align:center;font-weight:bold;min-width:90px">å¯ç”¨é¢„è­¦</th>
                <th style="padding:14px 12px;text-align:center;font-weight:bold;min-width:100px">æ°´ä½é˜ˆå€¼(m)</th>
                <th style="padding:14px 12px;text-align:center;font-weight:bold;min-width:100px">æ¶¨å¹…é˜ˆå€¼(m/h)</th>
                <th style="padding:14px 12px;text-align:center;font-weight:bold;min-width:110px">æŸ¥çœ‹è¶‹åŠ¿</th>
                <th style="padding:14px 12px;text-align:center;font-weight:bold;min-width:90px">ç¡®å®š</th>
              </tr>
            </thead>
            <tbody id="alertTableBody">
              <!-- åŠ¨æ€å¡«å…… -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- åº•éƒ¨æç¤º -->
      <div style="margin-top:16px;padding:14px;background:linear-gradient(135deg,#fff7e6,#ffe7ba);border-radius:8px;border-left:4px solid #faad14;color:#ad6800;font-size:12px">
        <p style="margin:0;font-weight:bold;margin-bottom:6px">âš¡ é‡è¦æç¤º</p>
        <ul style="margin:0;padding-left:20px;line-height:1.6">
          <li>æ‰€æœ‰é¢„è­¦è®¾ç½®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</li>
          <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–ä½¿ç”¨éšç§æµè§ˆæ¨¡å¼å¯èƒ½å¯¼è‡´è®¾ç½®ä¸¢å¤±</li>
          <li>å»ºè®®å®šæœŸå¯¼å‡ºé…ç½®è¿›è¡Œå¤‡ä»½</li>
          <li>é¢„è­¦é€šçŸ¥éœ€è¦æ‚¨åœ¨æµè§ˆå™¨ä¸­å…è®¸é€šçŸ¥æƒé™</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- AI é…ç½®é¢æ¿ -->
  <div id="apiConfigModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9998;animation:fadeIn 0.3s">
  </div>
  <div id="apiConfigPanel" style="display:none;position:fixed;top:80px;right:20px;width:420px;background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid rgba(155,89,182,0.4);border-radius:12px;padding:24px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);max-height:calc(100vh - 120px);overflow-y:auto;animation:slideIn 0.3s ease-out">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid rgba(155,89,182,0.2);padding-bottom:12px">
      <h3 style="margin:0;color:#e8fdff;font-size:16px;font-weight:bold">âš™ï¸ AI æ¨¡å‹é…ç½®</h3>
      <button onclick="closeApiConfig()" style="background:transparent;border:none;color:#9fead6;font-size:20px;cursor:pointer;padding:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.3s">Ã—</button>
    </div>

    <!-- Qwen æ¨¡å‹é€‰æ‹© -->
    <div style="margin-bottom:18px">
      <label style="display:block;color:#c9f3ff;font-size:13px;font-weight:bold;margin-bottom:8px">ğŸ¤– Qwen æ¨¡å‹</label>
      <select id="qwenModelSelect" style="width:100%;padding:10px 12px;border:1px solid rgba(155,89,182,0.4);border-radius:6px;background:#0f1a2e;color:#c9f3ff;font-size:12px;cursor:pointer">
        <option value="qwen-plus">Qwen Plusï¼ˆæ¨èï¼‰</option>
        <option value="qwen-turbo">Qwen Turboï¼ˆå¿«é€Ÿï¼‰</option>
        <option value="qwen-max">Qwen Maxï¼ˆå¼ºåŠ›ï¼‰</option>
      </select>
    </div>

    <!-- API Key è¾“å…¥ -->
    <div style="margin-bottom:18px">
      <label style="display:block;color:#c9f3ff;font-size:13px;font-weight:bold;margin-bottom:8px">ğŸ”‘ Dashscope API Key</label>
      <input id="dashscopeApiKey" type="password" placeholder="sk-..." style="width:100%;padding:10px 12px;border:1px solid rgba(155,89,182,0.4);border-radius:6px;background:#0f1a2e;color:#c9f3ff;font-size:12px;box-sizing:border-box">
      <button id="toggleApiKeyBtn" onclick="toggleApiKeyVisibility()" style="margin-top:6px;padding:4px 8px;background:rgba(155,89,182,0.2);border:1px solid rgba(155,89,182,0.4);border-radius:4px;color:#9fead6;cursor:pointer;font-size:11px;transition:all 0.3s">ğŸ‘ï¸ æ˜¾ç¤º</button>
    </div>

    <!-- å¿«é€Ÿæµ‹è¯• -->
    <div style="margin-bottom:18px">
      <label style="display:block;color:#c9f3ff;font-size:13px;font-weight:bold;margin-bottom:8px">ğŸ’¬ å¿«é€Ÿæµ‹è¯•</label>
      <input id="testPrompt" type="text" placeholder="è¾“å…¥æµ‹è¯•é—®é¢˜..." value="ç®€è¦ä»‹ç»é˜³æœ”å¿çš„æ°´æ–‡ç‰¹ç‚¹" style="width:100%;padding:10px 12px;border:1px solid rgba(155,89,182,0.4);border-radius:6px;background:#0f1a2e;color:#c9f3ff;font-size:12px;box-sizing:border-box;margin-bottom:8px">
      <button id="testApiBtn" onclick="testQwenConnection()" style="width:100%;padding:10px 12px;background:linear-gradient(135deg,#0fbfc6,#13d4d6);border:none;border-radius:6px;color:#012;font-weight:bold;cursor:pointer;font-size:12px;transition:all 0.3s">ğŸ§ª æµ‹è¯•è¿æ¥</button>
      <div id="testResult" style="margin-top:8px;padding:10px;background:rgba(15,191,198,0.1);border-radius:6px;color:#c9f3ff;font-size:11px;display:none;max-height:120px;overflow-y:auto;border:1px solid rgba(15,191,198,0.2)"></div>
    </div>

    <!-- é…ç½®è¯´æ˜ -->
    <div style="padding:12px;background:rgba(155,89,182,0.1);border-radius:6px;border:1px solid rgba(155,89,182,0.2);margin-bottom:18px">
      <p style="margin:0 0 8px 0;color:#9fead6;font-size:11px;font-weight:bold">ğŸ“ é…ç½®è¯´æ˜</p>
      <ul style="margin:0;padding-left:16px;color:#c9f3ff;font-size:11px;line-height:1.6">
        <li>éœ€è¦ä» <a href="https://dashscope.aliyun.com" target="_blank" style="color:#0fbfc6;text-decoration:underline">é˜¿é‡Œäº‘ Dashscope</a> è·å– API Key</li>
        <li>API Key ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
        <li>ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€åˆ·æ–°é¡µé¢</li>
        <li>æ¨èä½¿ç”¨ Qwen Plus è·å¾—æœ€ä½³ä½“éªŒ</li>
      </ul>
    </div>

    <!-- ä¿å­˜æŒ‰é’® -->
    <button id="saveApiConfigBtn" onclick="saveApiConfig()" style="width:100%;padding:12px;background:linear-gradient(135deg,#9b59b6,#8e44ad);border:none;border-radius:6px;color:#fff;font-weight:bold;cursor:pointer;font-size:13px;transition:all 0.3s;box-shadow:0 2px 8px rgba(155,89,182,0.4)">
      âœ… ä¿å­˜é…ç½®
    </button>

    <!-- æ¸…é™¤æŒ‰é’® -->
    <button id="clearApiConfigBtn" onclick="clearApiConfig()" style="width:100%;margin-top:8px;padding:10px;background:rgba(232,100,100,0.1);border:1px solid rgba(232,100,100,0.4);border-radius:6px;color:#e86464;font-weight:bold;cursor:pointer;font-size:12px;transition:all 0.3s">
      ğŸ—‘ï¸ æ¸…é™¤é…ç½®
    </button>
  </div>

  <style>
    @keyframes slideIn {
      from {
        transform: translateX(450px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>

</body>
</html>











